<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Technical Downtime Tracking App - Production</title>
  <!-- PWA manifest and theme color -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0a6ed1">
  <!-- jsPDF and html2canvas for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous"></script>
<style>
  :root{
    --sap-shell-bg:#f7f7f7;
    --sap-panel:#ffffff;
    --sap-accent:#0a6ed1;
    --sap-accent-2:#0854a0;
    --sap-text:#222;
    --sap-muted:#6a6d70;
    --sap-border:#d9d9d9;
    --sap-success:#107e3e;
    --sap-warning:#e9730c;
    --sap-error:#bb0000;
    --radius:8px;
    --gap:12px;
  }
  
  /* Dark Mode Variables */
  body.dark-mode {
    --sap-shell-bg:#1a1a1a;
    --sap-panel:#2d2d2d;
    --sap-accent:#3d9bff;
    --sap-accent-2:#2d7dcc;
    --sap-text:#e0e0e0;
    --sap-muted:#a0a0a0;
    --sap-border:#404040;
    --sap-success:#4caf50;
    --sap-warning:#ff9800;
    --sap-error:#f44336;
  }
  
  body.dark-mode .app-header {
    background:linear-gradient(180deg,#1e3a5f 0%, #0d2744 100%);
  }
  
  body.dark-mode input[type="text"],
  body.dark-mode input[type="time"],
  body.dark-mode input[type="number"],
  body.dark-mode input[type="password"],
  body.dark-mode select {
    background:#3a3a3a;
    color:var(--sap-text);
    border-color:var(--sap-border);
  }
  
  body.dark-mode .table th {
    background:linear-gradient(180deg, #3a3a3a 0%, #2d2d2d 100%);
  }
  
  body.dark-mode .table td {
    background:#2d2d2d;
  }
  
  body.dark-mode .table tbody tr:hover td {
    background:#3a3a3a;
  }
  
  body.dark-mode .timeline-scale,
  body.dark-mode .timeline-right-header {
    background:linear-gradient(180deg, #3a3a3a 0%, #2d2d2d 100%);
  }
  
  body.dark-mode .timeline-control-cell {
    background:linear-gradient(180deg, #3a3a3a 0%, #2d2d2d 100%);
  }
  
  body.dark-mode .btn {
    background:#3a3a3a;
    color:var(--sap-text);
    border-color:var(--sap-border);
  }
  
  body.dark-mode .btn:hover:not(:disabled) {
    background:#4a4a4a;
  }
  
  body.dark-mode .time-display {
    background:#1e3a5f;
    border-color:#2d4f7f;
    color:#3d9bff;
  }
  
  body.dark-mode .info-box {
    background:#1e3a5f;
    border-color:#2d4f7f;
    color:#3d9bff;
  }
  
  *{
    box-sizing: border-box;
  }
  
  html,body{
    margin:0;
    padding:0;
    background:var(--sap-shell-bg);
    color:var(--sap-text);
    font:14px/1.4 "72","Segoe UI",Roboto,Arial,sans-serif;
    min-height: 100vh;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  .app-header{
    background:linear-gradient(180deg,#0b74de 0%, #095cab 100%);
    color:#fff;
    padding:12px 16px;
    display:flex;
    align-items:center;
    gap:12px;
    justify-content:space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .brand svg{
    height:28px;
    width:auto;
  }
  
  h1{
    margin:0;
    font-size:18px;
    font-weight:600;
    letter-spacing:.2px;
  }
  
  .status-display{
    display:flex;
    gap:20px;
    align-items:center;
    font-size:13px;
  }
  
  .status-item{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  
  .status-label{
    opacity:0.9;
    font-size:11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .status-value{
    font-size:16px;
    font-weight:700;
  }
  
  /* Password Protection Modal */
  .password-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100000;
  }
  
  .password-modal.hidden {
    display: none;
  }
  
  .password-content {
    background: var(--sap-panel);
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    max-width: 450px;
    width: 90%;
    text-align: center;
  }
  
  .password-content h2 {
    margin: 0 0 20px 0;
    color: var(--sap-accent);
  }
  
  .password-content input {
    width: 100%;
    padding: 12px;
    margin: 16px 0;
    border: 2px solid var(--sap-border);
    border-radius: 8px;
    font-size: 16px;
    text-align: center;
  }
  
  .password-content .btn {
    width: 100%;
    margin-top: 8px;
  }
  
  .password-error {
    color: var(--sap-error);
    margin-top: 12px;
    font-size: 14px;
  }
  
  .user-guide {
    text-align: left;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--sap-border);
    font-size: 13px;
    line-height: 1.6;
  }
  
  .user-guide h3 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: var(--sap-accent);
  }
  
  .user-guide ul {
    margin: 8px 0;
    padding-left: 20px;
  }
  
  .user-guide li {
    margin: 6px 0;
  }
  
  /* Dark Mode Toggle Button */
  .dark-mode-toggle {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    padding: 6px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    transition: all 0.3s ease;
  }
  
  .dark-mode-toggle:hover {
    background: rgba(255,255,255,0.3);
  }
  
  /* Full Screen Toggle Button */
  .fullscreen-toggle {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    padding: 6px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    transition: all 0.3s ease;
  }
  
  .fullscreen-toggle:hover {
    background: rgba(255,255,255,0.3);
  }
  
  .fullscreen-toggle.active {
    background: rgba(255,255,255,0.4);
    border-color: rgba(255,255,255,0.5);
  }
  
  /* Full Screen Mode Styles */
  body.fullscreen-mode .customer-info-panel {
    display: none !important;
  }
  
  body.fullscreen-mode .model-parameters-panel {
    display: none !important;
  }
  
  body.fullscreen-mode #progressPanel {
    margin-bottom: 0;
    height: calc(100vh - 80px);
    display: flex;
    flex-direction: column;
  }
  
  body.fullscreen-mode .timeline-container {
    flex: 1;
    display: flex;
    min-height: 0;
  }
  
  body.fullscreen-mode .content {
    padding: 8px;
    height: calc(100vh - 80px);
    display: flex;
    flex-direction: column;
  }
  
  body.fullscreen-mode .app-header {
    padding: 8px 16px;
  }
  
  body.fullscreen-mode h1 {
    font-size: 16px;
  }
  
  body.fullscreen-mode .status-display {
    gap: 16px;
  }
  
  body.fullscreen-mode .fullscreen-customer-info {
    display: flex !important;
    gap: 16px;
    align-items: center;
    font-size: 13px;
    padding: 4px 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
  }
  
  .fullscreen-customer-info {
    display: none;
  }
  
  .fullscreen-customer-info .info-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .fullscreen-customer-info .info-label {
    font-size: 10px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .fullscreen-customer-info .info-value {
    font-size: 13px;
    font-weight: 600;
  }
  
  /* Completion Progress */
  .completion-progress {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 120px;
  }
  
  .progress-bar-container {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 4px;
  }
  
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  
  .progress-percentage {
    font-size: 16px;
    font-weight: 700;
  }
  
  /* Recent Customers Dropdown */
  .customer-input-wrapper {
    position: relative;
    flex: 1;
  }
  
  .recent-customers-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    color: var(--sap-accent);
    font-size: 12px;
    transition: color 0.2s;
  }
  
  .recent-customers-btn:hover {
    color: var(--sap-accent-2);
  }
  
  .recent-customers-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: var(--sap-panel);
    border: 1px solid var(--sap-border);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
  }
  
  .recent-customers-dropdown.show {
    display: block;
  }
  
  .recent-customer-item {
    padding: 10px 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    border-bottom: 1px solid var(--sap-border);
    font-size: 14px;
  }
  
  .recent-customer-item:last-child {
    border-bottom: none;
  }
  
  .recent-customer-item:hover {
    background: rgba(10,110,209,0.1);
  }
  
  .recent-customer-item-empty {
    padding: 20px;
    text-align: center;
    color: var(--sap-muted);
    font-size: 13px;
  }
  
  /* Enhanced Tooltip */
  .enhanced-tooltip {
    position: fixed;
    background: var(--sap-panel);
    border: 2px solid var(--sap-accent);
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 10000;
    pointer-events: none;
    display: none;
    min-width: 300px;
    max-width: 400px;
  }
  
  body.dark-mode .enhanced-tooltip {
    background: #2d2d2d;
    border-color: #3d9bff;
  }
  
  .enhanced-tooltip.show {
    display: block;
  }
  
  .tooltip-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--sap-border);
  }
  
  .tooltip-icon {
    font-size: 32px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--sap-accent), var(--sap-accent-2));
    color: white;
  }
  
  .tooltip-title {
    flex: 1;
    font-size: 18px;
    font-weight: 600;
    color: var(--sap-text);
  }
  
  .tooltip-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .tooltip-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  
  .tooltip-label {
    font-weight: 600;
    color: var(--sap-muted);
    min-width: 100px;
  }
  
  .tooltip-value {
    color: var(--sap-text);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .status-icon {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }
  
  .status-icon.not-started { background: #9e9e9e; }
  .status-icon.in-progress { background: #2196f3; animation: pulse-dot 2s infinite; }
  .status-icon.blocked { background: #f44336; }
  .status-icon.completed { background: #4caf50; }
  .status-icon.skipped { background: #ff9800; }
  .status-icon.in-error { background: #d32f2f; animation: blink-error 1s infinite; }
  
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
  }
  
  @keyframes blink-error {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.4; }
  }
  
  /* Search/Filter Box */
  .search-filter-container {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  
  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
  }
  
  .search-box input {
    width: 100%;
    padding: 9px 36px 9px 12px;
  }
  
  .search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--sap-muted);
    pointer-events: none;
  }
  
  .filter-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  .filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: var(--sap-accent);
    color: white;
    border-radius: 16px;
    font-size: 12px;
  }
  
  .filter-tag button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    margin: 0;
    font-size: 14px;
  }
  
  /* Template Management */
  .template-section {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 2px solid var(--sap-border);
  }
  
  .template-controls {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
  }
  
  .template-field {
    flex: 1;
    min-width: 200px;
  }
  
  .template-list {
    margin-top: 16px;
    border: 1px solid var(--sap-border);
    border-radius: 6px;
    overflow: hidden;
  }
  
  .template-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px solid var(--sap-border);
    transition: background-color 0.2s;
  }
  
  .template-item:last-child {
    border-bottom: none;
  }
  
  .template-item:hover {
    background: rgba(10,110,209,0.05);
  }
  
  .template-info {
    flex: 1;
  }
  
  .template-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
  }
  
  .template-meta {
    font-size: 12px;
    color: var(--sap-muted);
  }
  
  .template-actions {
    display: flex;
    gap: 8px;
  }
  
  /* Elapsed Time Badge */
  .elapsed-time-badge {
    position: absolute;
    bottom: -18px;
    left: 4px;
    font-size: 9px;
    padding: 1px 4px;
    border-radius: 3px;
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffe08a;
    pointer-events: none;
    font-weight: 600;
  }
  
  /* Task Status Indicators */
  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .status-not-started {
    background: #e9ecef;
    color: #6c757d;
  }
  
  .status-in-progress {
    background: #cfe2ff;
    color: #084298;
    animation: pulse-status 2s infinite;
  }
  
  .status-blocked {
    background: #f8d7da;
    color: #842029;
  }
  
  .status-completed {
    background: #d1e7dd;
    color: #0f5132;
  }
  
  .status-skipped {
    background: #fff3cd;
    color: #997404;
  }
  
  .status-in-error {
    background: #f8d7da;
    color: #d32f2f;
    animation: pulse-status 2s infinite;
  }
  
  @keyframes pulse-status {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  .status-select {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    border: 1px solid var(--sap-border);
  }
  
  /* Drag Handle for Row Reordering */
  .drag-handle {
    cursor: grab;
    padding: 4px;
    color: var(--sap-muted);
    display: inline-flex;
    align-items: center;
  }
  
  .drag-handle:active {
    cursor: grabbing;
  }
  
  .drag-handle:hover {
    color: var(--sap-accent);
  }
  
  tr.dragging {
    opacity: 0.5;
  }
  
  tr.drag-over {
    border-top: 2px solid var(--sap-accent);
  }
  
  /* Keyboard Shortcuts Help */
  .keyboard-shortcuts-help {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--sap-panel);
    border: 1px solid var(--sap-border);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    padding: 24px;
    z-index: 10000;
    max-width: 500px;
    display: none;
  }
  
  .keyboard-shortcuts-help.show {
    display: block;
  }
  
  .keyboard-shortcuts-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: none;
  }
  
  .keyboard-shortcuts-overlay.show {
    display: block;
  }
  
  .shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--sap-border);
  }
  
  .shortcut-item:last-child {
    border-bottom: none;
  }
  
  .shortcut-key {
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    border: 1px solid var(--sap-border);
  }
  
  body.dark-mode .shortcut-key {
    background: #3a3a3a;
  }
  
  .content{
    padding:16px;
    max-width: 1600px;
    margin: 0 auto;
  }
  
  .panel{
    background:var(--sap-panel);
    border:1px solid var(--sap-border);
    border-radius:var(--radius);
    padding:20px;
    box-shadow:0 2px 4px rgba(0,0,0,.06);
    margin-bottom:16px;
  }
  
  .panel:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,.1);
    transition: box-shadow 0.3s ease;
  }
  
  h2{
    margin:0 0 12px 0;
    font-size:18px;
    font-weight:600;
    color:var(--sap-text);
  }
  
  h3{
    margin:20px 0 10px 0;
    font-size:13px;
    color:var(--sap-accent);
    text-transform:uppercase;
    letter-spacing:.5px;
    font-weight:600;
  }
  
  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-bottom:16px;
  }
  
  .field-row{
    display:flex;
    gap:16px;
    align-items:flex-end;
  }
  
  label{
    font-size:12px;
    color:var(--sap-muted);
    font-weight:500;
  }
  
  input[type="text"],
  input[type="time"],
  input[type="number"],
  input[type="password"],
  select{
    padding:9px 12px;
    border:1px solid var(--sap-border);
    border-radius:6px;
    background:#fff;
    color:var(--sap-text);
    font-size:14px;
    transition:border-color 0.2s, box-shadow 0.2s;
  }
  
  input[type="text"]:focus,
  input[type="time"]:focus,
  input[type="number"]:focus,
  input[type="password"]:focus,
  select:focus{
    outline:none;
    border-color:var(--sap-accent);
    box-shadow: 0 0 0 3px rgba(10,110,209,0.1);
  }
  
  input[type="number"]{
    text-align:right;
  }
  
  input[readonly],
  input:disabled,
  select:disabled{
    background:#f8fafb;
    cursor:default;
    opacity: 0.7;
  }
  
  body.dark-mode input[readonly],
  body.dark-mode input:disabled,
  body.dark-mode select:disabled {
    background:#252525;
  }
  
  .time-display{
    font-family:'Courier New', monospace;
    font-size:15px;
    font-weight:600;
    color:var(--sap-accent-2);
    padding:8px 12px;
    background:#f0f7ff;
    border:1px solid #cce0f5;
    border-radius:6px;
    min-width:100px;
    text-align:center;
  }
  
  .time-input{
    font-family:'Courier New', monospace;
    font-size:15px;
    font-weight:600;
    color:var(--sap-accent-2);
    padding:8px 12px;
    background:#fff;
    border:1px solid #cce0f5;
    border-radius:6px;
    min-width:100px;
    text-align:center;
  }
  
  .time-input:focus{
    border-color:var(--sap-accent);
    box-shadow:0 0 0 2px rgba(10,110,209,0.1);
  }
  
  .table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    margin-top:12px;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
  }
  
  .table th,
  .table td{
    border-bottom:1px solid var(--sap-border);
    border-right:1px solid var(--sap-border);
    padding:10px;
    text-align:left;
    vertical-align:middle;
  }
  
  .table th:last-child,
  .table td:last-child{
    border-right:none;
  }
  
  .table tbody tr:last-child td{
    border-bottom:none;
  }
  
  .table th{
    background:linear-gradient(180deg, #f8fafb 0%, #f2f5f7 100%);
    font-weight:600;
    font-size:12px;
    color:var(--sap-text);
    text-transform:uppercase;
    letter-spacing:0.5px;
    position: sticky;
    top: 0;
  }
  
  .table td{
    background:#fff;
    font-size:14px;
  }
  
  .table tbody tr{
    transition: background-color 0.2s;
  }
  
  .table tbody tr:hover td{
    background:#f8fafb;
  }
  
  .table td.center,
  .table th.center{
    text-align:center;
  }
  
  .btn{
    padding:9px 14px;
    border-radius:6px;
    border:1px solid var(--sap-border);
    background:#fff;
    color:var(--sap-text);
    cursor:pointer;
    font-size:14px;
    font-weight:500;
    transition:all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .btn:hover:not(:disabled){
    background:#f5f5f5;
    border-color:var(--sap-accent);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .btn:active:not(:disabled){
    transform: translateY(0);
  }
  
  .btn:disabled{
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .btn.primary{
    background:var(--sap-accent);
    color:#fff;
    border-color:var(--sap-accent-2);
  }
  
  .btn.primary:hover:not(:disabled){
    background:var(--sap-accent-2);
  }
  
  .btn.warning{
    background:var(--sap-warning);
    color:#fff;
    border-color:#d96a0c;
  }
  
  .btn.warning:hover:not(:disabled){
    background:#d96a0c;
  }
  
  .btn.small{
    padding:6px 10px;
    font-size:12px;
  }
  
  .btn.danger{
    background:#fff;
    color:var(--sap-error);
    border-color:var(--sap-error);
  }
  
  .btn.danger:hover:not(:disabled){
    background:#fee;
    color:var(--sap-error);
  }
  
  .btnbar{
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:16px;
    flex-wrap: wrap;
  }
  
  /* Timeline Styles */
  .timeline-container{
    background:#fff;
    border:1px solid var(--sap-border);
    border-radius:8px;
    padding:0;
    margin-top:16px;
    overflow-x:auto;
    position:relative;
    display:flex;
    width:100%;
    min-height: 200px;
  }
  
  body.dark-mode .timeline-container {
    background:#2d2d2d;
  }
  
  .timeline-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    padding-bottom:12px;
    border-bottom:1px solid var(--sap-border);
    flex-wrap: wrap;
    gap: 16px;
  }
  
  .timeline-info{
    display:flex;
    gap:30px;
    flex-wrap: wrap;
  }
  
  .timeline-field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  
  .timeline-field label{
    font-size:11px;
    color:var(--sap-muted);
  }
  
  .timeline-scroll{
    flex:1 1 auto;
    overflow-x:auto;
    overflow-y:hidden;
    position:relative;
  }
  
  .timeline-right{
    flex:0 0 270px;
    display:flex;
    flex-direction:column;
    border-left:2px solid var(--sap-border);
    background: #fafbfc;
  }
  
  body.dark-mode .timeline-right {
    background: #252525;
  }
  
  .timeline-right-header{
    display:grid;
    grid-template-columns:70px 70px 60px 70px;
    align-items:center;
    height:24px;
    background:linear-gradient(180deg, #f8fafb 0%, #f2f5f7 100%);
    border-bottom:1px solid var(--sap-border);
  }
  
  .timeline-right-header .header-cell{
    font-weight:600;
    font-size:10px;
    text-transform:uppercase;
    color:var(--sap-muted);
    display:flex;
    align-items:center;
    justify-content:center;
    border-right:1px solid #e5e5e5;
    padding:0;
    height:100%;
  }
  
  .timeline-right-header .header-cell:last-child{
    border-right:none;
  }
  
  #timelineControlsRows{
    display:flex;
    flex-direction:column;
  }
  
  .timeline-row{
    display:flex;
    align-items:center;
    height:28px;
    border-bottom:1px solid #e5e5e5;
    position:relative;
    transition:background 0.2s;
  }
  
  .timeline-row:hover{
    background:rgba(10,110,209,0.03);
  }
  
  .timeline-row:last-child{
    border-bottom:none;
  }
  
  .timeline-track{
    flex:0 0 auto;
    height:28px;
    position:relative;
    background-image:repeating-linear-gradient(
      90deg,
      transparent,
      transparent 59px,
      #e5e5e5 59px,
      #e5e5e5 60px
    );
    background-position:0 0;
    border-right:2px solid var(--sap-border);
  }
  
  .timeline-control-row{
    display:grid;
    grid-template-columns:70px 70px 60px 70px;
    height:28px;
    border-bottom:1px solid #e5e5e5;
  }
  
  .timeline-control-cell{
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:var(--sap-text);
    background:linear-gradient(180deg, #fafbfc 0%, #f8f9fa 100%);
    border-right:1px solid #e5e5e5;
  }
  
  .timeline-control-row .timeline-control-cell:last-child{
    border-right:none;
  }
  
  .timeline-control-cell input[type="text"]{
    width:90%;
    text-align:center;
    border:1px solid #d5d5d5;
    border-radius:3px;
    font-size:11px;
    padding:2px 3px;
  }
  
  .timeline-control-cell input[type="text"]:focus{
    border-color:var(--sap-accent);
    box-shadow:0 0 0 2px rgba(10,110,209,0.1);
  }
  
  .timeline-control-cell input[type="checkbox"]{
    cursor:pointer;
    width:16px;
    height:16px;
    accent-color:var(--sap-success);
  }
  
  .timeline-scale{
    height:24px;
    position:relative;
    background:linear-gradient(180deg, #f8fafb 0%, #f2f5f7 100%);
    border-bottom:1px solid var(--sap-border);
    border-right:2px solid var(--sap-border);
    flex:0 0 auto;
  }
  
  .timeline-hour{
    position:absolute;
    font-size:10px;
    color:var(--sap-muted);
    top:5px;
    font-weight:600;
    user-select: none;
  }
  
  .timeline-hour:hover{
    color:var(--sap-accent);
  }
  
  .timeline-block{
    position:absolute;
    height:16px;
    top:6px;
    border-radius:3px;
    cursor:move;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0 4px;
    color:#fff;
    font-size:9px;
    font-weight:600;
    transition:opacity 0.2s, transform 0.2s;
    box-shadow:0 1px 2px rgba(0,0,0,0.2);
    user-select:none;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  
  .timeline-block:hover{
    opacity:0.9;
    z-index:10;
    transform: scale(1.05);
  }
  
  .timeline-block.dragging{
    opacity:0.7;
    z-index:20;
  }
  
  .timeline-block.completed{
    background-image:repeating-linear-gradient(
      45deg,
      transparent,
      transparent 10px,
      rgba(255,255,255,0.3) 10px,
      rgba(255,255,255,0.3) 20px
    );
    opacity:0.4;
    filter: grayscale(100%);
  }
  
  /* Block label outside */
  .block-label-external{
    position:absolute;
    left:100%;
    margin-left:6px;
    white-space:nowrap;
    color:var(--sap-text);
    font-size:12px;
    font-weight:500;
    top:50%;
    transform:translateY(-50%);
    pointer-events:none;
    background: rgba(255,255,255,0.9);
    padding: 0 4px;
    border-radius: 3px;
  }
  
  body.dark-mode .block-label-external {
    background: rgba(45,45,45,0.95);
  }
  
  /* Quality gate label - horizontal and positioned on track */
  .quality-gate-label{
    white-space:nowrap;
    color:var(--sap-text);
    font-size:12px;
    font-weight:600;
    pointer-events:none;
    background: rgba(255,255,255,0.95);
    padding: 2px 6px;
    border-radius: 3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    z-index: 5;
  }
  
  body.dark-mode .quality-gate-label {
    background: rgba(45,45,45,0.95);
  }
  
  /* Critical path indicators */
  .timeline-block.critical {
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 0 2px 4px rgba(0,0,0,0.3);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 0 2px 4px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 0 16px rgba(255, 0, 0, 0.8), 0 2px 4px rgba(0,0,0,0.3); }
    100% { box-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 0 2px 4px rgba(0,0,0,0.3); }
  }
  
  .critical-indicator {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 14px;
    height: 14px;
    background: #ff0000;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 9px;
    font-weight: bold;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .table .critical-cell {
    text-align: center;
  }
  
  .critical-checkbox {
    cursor: pointer;
    width: 16px;
    height: 16px;
    accent-color: var(--sap-error);
  }
  
  .finish-line {
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    background:var(--sap-error);
    z-index:10;
    pointer-events: none;
  }
  
  .finish-line::before{
    content:'FINISH';
    position:absolute;
    top:-20px;
    left:50%;
    transform:translateX(-50%);
    font-size: 9px;
    font-weight: bold;
    color: var(--sap-error);
    white-space: nowrap;
  }
  
  .current-time-line{
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    background:#00ff00;
    z-index:15;
    pointer-events:none;
    box-shadow: 0 0 8px rgba(0,255,0,0.5);
  }
  
  .current-time-label{
    position:absolute;
    top:-22px;
    left:50%;
    transform:translateX(-50%);
    background:var(--sap-success);
    color:#fff;
    padding:2px 6px;
    border-radius:3px;
    font-size:10px;
    font-weight:600;
    white-space:nowrap;
  }
  
  /* Block Colors */
  .block-preparation{background:#795548;}
  .block-export{background:#4CAF50;}
  .block-import{background:#2196F3;}
  .block-quality{background:#FF9800;}
  .block-qualitygate{background:#FF9800;}
  .block-conversion{background:#9C27B0;}
  .block-validation{background:#00BCD4;}
  
  .runblock-name{
    font-size:10px;
    color:var(--sap-muted);
    white-space:nowrap;
    pointer-events:none;
  }
  
  .quality-diamond{
    position:absolute;
    width:14px;
    height:14px;
    background:#FF9800;
    transform:rotate(45deg);
    top:50%;
    margin-top:-7px;
    border-radius:2px;
    box-shadow:0 1px 2px rgba(0,0,0,0.2);
  }
  
  .legend{
    display:flex;
    gap:16px;
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid var(--sap-border);
    font-size:12px;
    flex-wrap:wrap;
    align-items:center;
  }
  
  .legend-item{
    display:flex;
    align-items:center;
    gap:6px;
  }
  
  .legend-color{
    width:16px;
    height:16px;
    border-radius:3px;
  }
  
  .info-box{
    background:#f0f7ff;
    border:1px solid #cce0f5;
    border-radius:6px;
    padding:12px;
    margin-top:12px;
    font-size:12px;
    color:var(--sap-accent-2);
  }
  
  .btn.success{
    background:var(--sap-success);
    color:#fff;
    border-color:#0b6d34;
  }
  
  .btn.success:hover:not(:disabled){
    background:#0b6d34;
  }
  
  .hidden{
    display:none !important;
  }
  
  /* Validation warnings */
  .validation-warning {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 8px 12px;
    margin: 8px 0;
    font-size: 12px;
    color: #856404;
    animation: slideDown 0.3s ease;
  }
  
  body.dark-mode .validation-warning {
    background: #664d03;
    border-color: #ffca2c;
    color: #ffecb5;
  }
  
  @keyframes slideDown {
    from { 
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .conflict-indicator {
    background: #ff6b6b;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 4px;
  }
  
  @media print{
    body *{ visibility:hidden !important; }
    #progressPanel, #progressPanel *{ visibility:visible !important; }
    #progressPanel{ position:fixed; left:0; top:0; width:100%; }
    .timeline-container{ overflow:visible !important; }
    #rt-reset, #rt-copy { display: none !important; }
  }
  
  /* Ensure viewer mode readonly styling */
  .viewer-mode input:not(#rt-copy),
  .viewer-mode select,
  .viewer-mode textarea,
  .viewer-mode button:not(#rt-copy):not(#rt-reset):not(#reportBtn):not(#fullscreenToggle):not(#darkModeToggle) {
    pointer-events: none !important;
    opacity: 0.6 !important;
  }
  
  .viewer-mode .timeline-checkbox {
    pointer-events: none !important;
  }
  
  .viewer-mode .timeline-block {
    cursor: default !important;
  }
  
  .viewer-mode #rt-copy,
  .viewer-mode #rt-reset,
  .viewer-mode #reportBtn,
  .viewer-mode #fullscreenToggle,
  .viewer-mode #darkModeToggle {
    pointer-events: auto !important;
    opacity: 1 !important;
  }
  
  /* Performance improvements */
  .timeline-block, .quality-diamond {
    will-change: transform;
  }
  
  .current-time-line {
    will-change: left;
  }
  
  /* Status indicators */
  .sync-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00ff00;
    display: inline-block;
    margin-left: 8px;
    animation: blink 2s infinite;
  }
  
  @keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.3; }
  }
  
  .sync-indicator.offline {
    background: #ff0000;
    animation: none;
  }
  
  /* Responsive design */
  @media (max-width: 768px) {
    .timeline-right {
      flex: 0 0 200px;
    }
    
    .timeline-right-header {
      grid-template-columns: 60px 60px 40px 40px;
    }
    
    .timeline-info {
      flex-direction: column;
      gap: 16px;
    }
    
    .status-display {
      flex-direction: column;
      gap: 10px;
    }
  }

/* --- Enhancements CSS --- */
.input-invalid{
  border-color:#ffc107 !important;
  box-shadow:0 0 0 3px rgba(255,193,7,.15) !important;
}

.conflict-overlay{
  position:absolute;
  top:0; bottom:0;
  background:rgba(255,0,0,0.08);
  border-top:1px dashed rgba(255,0,0,0.4);
  border-bottom:1px dashed rgba(255,0,0,0.4);
  pointer-events:none;
  z-index:5;
}

.slack-badge{
  position:absolute;
  bottom:-18px;
  right:4px;
  font-size:9px;
  padding:1px 4px;
  border-radius:3px;
  background:#e6ffed;
  color:#107e3e;
  border:1px solid #b7f5c7;
  pointer-events:none;
}

.quick-fix{
  position:absolute;
  top:-18px;
  right:4px;
  font-size:10px;
  padding:2px 6px;
  border-radius:3px;
  background:#fff3cd;
  color:#856404;
  border:1px solid #ffe08a;
  cursor:pointer;
}
.quick-fix:hover{ filter:brightness(0.95); }

/* === Message visibility toggle === */
.messages-off .validation-warning,
.messages-off #validationMessages,
.messages-off .conflict-indicator,
.messages-off .conflict-overlay,
.messages-off .slack-badge,
.messages-off .quick-fix,
.messages-off .info-box,
.messages-off [role="alert"] { 
  display: none !important; 
}

#messageToggleBtn{
  padding:6px 12px; 
  border:1px solid var(--sap-border); 
  border-radius:6px;
  background:var(--sap-panel); 
  cursor:pointer; 
  font-size:12px;
  transition: all 0.2s;
}

#messageToggleBtn:hover{
  background:#f5f5f5;
  border-color:var(--sap-accent);
}

body.dark-mode #messageToggleBtn:hover{
  background:#4a4a4a;
}

#messageToggleBtn[aria-pressed="true"]{ 
  font-weight:600;
  background: var(--sap-accent);
  color: white;
  border-color: var(--sap-accent-2);
}

</style>

<script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js" 
  integrity="sha384-QtTBFeFlfRDZBfwHJHYQp7MdLJ2C3sfAEB1Qpy+YblvjavBye+q87TELpTnvlXw4" 
  crossorigin="anonymous"></script>
</head>
<body>
  <!-- Password Protection Modal -->
  <div class="password-modal" id="passwordModal">
    <div class="password-content">
      <h2>üîí Secure Access</h2>
      <p>Please enter the password to access the Downtime Tracking App</p>
      <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="off">
      <button class="btn primary" onclick="checkPassword()">Unlock</button>
      <div class="password-error" id="passwordError"></div>
      
      <div class="user-guide">
        <h3>üìñ Quick Start Guide</h3>
        <ul>
          <li><strong>Host Mode:</strong> First user becomes the host and can edit all data</li>
          <li><strong>Viewer Mode:</strong> Additional users can view live progress</li>
          <li><strong>Password:</strong> <code>downtime2025</code></li>
          <li><strong>Share Link:</strong> Click "üìã Copy link" to share viewer access</li>
          <li><strong>Templates:</strong> Save/load runbook configurations for reuse</li>
          <li><strong>Focus Mode:</strong> Press 'F' or click Focus button for fullscreen</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Enhanced Tooltip -->
  <div class="enhanced-tooltip" id="enhancedTooltip">
    <div class="tooltip-header">
      <div class="tooltip-icon" id="tooltipIcon">üì¶</div>
      <div class="tooltip-title" id="tooltipTitle">Runblock Name</div>
    </div>
    <div class="tooltip-body">
      <div class="tooltip-row">
        <span class="tooltip-label">Responsibility:</span>
        <span class="tooltip-value" id="tooltipResponsibility">‚Äî</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">Status:</span>
        <span class="tooltip-value" id="tooltipStatus">
          <span class="status-icon" id="tooltipStatusIcon"></span>
          <span id="tooltipStatusText">‚Äî</span>
        </span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">Phase:</span>
        <span class="tooltip-value" id="tooltipPhase">‚Äî</span>
      </div>
      <div class="tooltip-row">
        <span class="tooltip-label">Strategy:</span>
        <span class="tooltip-value" id="tooltipStrategy">‚Äî</span>
      </div>
    </div>
  </div>

  <div class="app-header">
    <div class="brand">
      <svg viewBox="0 0 100 28" xmlns="http://www.w3.org/2000/svg">
        <rect width="100" height="28" fill="#fff" rx="4"/>
        <text x="50" y="20" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#0a6ed1">SNP</text>
      </svg>
      <h1>Technical Downtime Tracking <span class="sync-indicator" id="syncIndicator"></span></h1>
    </div>
    <div class="fullscreen-customer-info" id="fullscreenCustomerInfo">
      <div class="info-item">
        <span class="info-label">Customer</span>
        <span class="info-value" id="fullscreenCustomerName">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Cycle</span>
        <span class="info-value" id="fullscreenTransformCycle">-</span>
      </div>
    </div>
    <div class="status-display">
      <div class="status-item">
        <span class="status-label">Current Time</span>
        <span class="status-value" id="currentTime">--:--:--</span>
      </div>
      <div class="status-item completion-progress">
        <span class="status-label">Completion</span>
        <span class="progress-percentage" id="completionPercentage">0%</span>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
      </div>
      <div class="status-item">
        <span class="status-label">Status</span>
        <span class="status-value" id="statusText" style="color:var(--sap-warning);">Not Started</span>
      </div>
      <button class="fullscreen-toggle" id="fullscreenToggle" title="Toggle full screen mode">
        <span id="fullscreenIcon">‚õ∂</span>
        <span id="fullscreenText">Focus</span>
      </button>
      <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle dark mode">
        <span id="darkModeIcon">üåô</span>
        <span id="darkModeText">Dark</span>
      </button>
    </div>
  </div>

  <div class="content">
    <!-- Customer Information -->
    <div class="panel customer-info-panel" style="margin-bottom:16px;padding:16px;">
      <div class="field-row">
        <div class="field customer-input-wrapper">
          <label>Customer Name *</label>
          <input type="text" id="customerName" placeholder="Enter customer name" value="">
          <button class="recent-customers-btn" id="recentCustomersBtn" title="Recent customers">‚ñº</button>
          <div class="recent-customers-dropdown" id="recentCustomersDropdown">
            <!-- Recent customers will be populated here -->
          </div>
        </div>
        <div class="field" style="flex:1;">
          <label>Transform Cycle</label>
          <select id="transformCycle">
            <option value="Test Migration">Test Migration</option>
            <option value="Go Live Simulation">Go Live Simulation</option>
            <option value="Go-Live">Go-Live</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Progress Tracking Section -->
    <div id="progressPanel" class="panel">
      <h2>Progress Tracking Window</h2>
      
      <div class="timeline-header">
        <div class="timeline-info">
          <div class="timeline-field">
            <label>Technical Downtime Duration (hrs)</label>
            <input type="number" id="downtimeDuration" min="1" max="168" value="24" 
                   onchange="updateTimeline();calculateEndTime()" style="width:80px;">
          </div>
          <div class="timeline-field">
            <label>Start Time</label>
            <div id="startTimeContainer">
              <input type="time" id="startTimeInput" class="time-input" 
                     onchange="calculateEndTime()" style="display:none;">
              <div class="time-display" id="startTimeDisplay">--:--:--</div>
            </div>
          </div>
          <div class="timeline-field">
            <label>Current Duration</label>
            <div id="currentDurationContainer">
              <input type="text" id="currentDurationInput" class="time-input" 
                     placeholder="HH:MM:SS" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" style="display:none;">
              <div class="time-display" id="currentDurationDisplay">00:00:00</div>
            </div>
          </div>
          <div class="timeline-field">
            <label>Estimated End Time</label>
            <div class="time-display" id="endTimeDisplay">--:--:--</div>
          </div>
        </div>
        <div id="downtimeControls">
          <button class="btn primary" id="startDowntimeBtn" onclick="startDowntime()">Start Downtime</button>
        </div>
      </div>

      <div id="validationMessages"></div>

      <div class="timeline-container">
        <div class="timeline-scroll">
          <div class="timeline-table-header">
            <div class="timeline-scale" id="timelineScale">
              <!-- Hour markers will be generated here -->
            </div>
          </div>
          <div id="timelineRows">
            <!-- Timeline track rows will be generated here -->
          </div>
          <div id="finishLine" class="finish-line"></div>
          <div class="current-time-line" id="currentTimeLine" style="display:none;">
            <div class="current-time-label" id="currentTimeLabel">00:00:00</div>
          </div>
        </div>
        <div class="timeline-right">
          <div class="timeline-right-header">
            <div class="header-cell">START</div>
            <div class="header-cell">PLAN</div>
            <div class="header-cell">END</div>
            <div class="header-cell">ACTUAL</div>
          </div>
          <div id="timelineControlsRows">
            <!-- Timeline control rows will be generated here -->
          </div>
        </div>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color block-preparation"></div>
          <span>Preparation</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-export"></div>
          <span>Export</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-import"></div>
          <span>Import</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-quality"></div>
          <span>Quality Gate</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-conversion"></div>
          <span>Conversion</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-validation"></div>
          <span>Validation</span>
        </div>
        <div class="legend-item">
          <div style="width:2px;height:16px;background:#00ff00;box-shadow:0 0 4px rgba(0,255,0,0.5);"></div>
          <span>Current Position</span>
        </div>
        <div class="legend-item">
          <div style="width:16px;height:16px;background:#ff0000;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:10px;font-weight:bold;">!</div>
          <span>Critical Path</span>
        </div>
        <div class="legend-item" style="margin-left:auto;">
          <button id="messageToggleBtn" type="button" aria-pressed="false" title="Show or hide all app messages & warnings">Messages: Off</button>
        </div>
        <button class="btn success" id="reportBtn" onclick="generatePDFReport()">üìÑ PDF Report</button>
      </div>
    </div>

    <!-- Model Parameters Section -->
    <div class="panel model-parameters-panel">
      <h2>Model Parameters</h2>

      <h3>Runbook Configuration</h3>
      
      <!-- Search/Filter Box -->
      <div class="search-filter-container">
        <div class="search-box">
          <input type="text" id="searchRunbooks" placeholder="üîç Search runbooks..." oninput="filterRunbooks()">
        </div>
        <div class="filter-controls">
          <select id="filterStrategy" onchange="filterRunbooks()">
            <option value="">All Strategies</option>
            <option value="Preparation">Preparation</option>
            <option value="Export">Export</option>
            <option value="Import">Import</option>
            <option value="Quality Gate">Quality Gate</option>
            <option value="Conversion">Conversion</option>
            <option value="Validation">Validation</option>
          </select>
          <select id="filterStatus" onchange="filterRunbooks()">
            <option value="">All Status</option>
            <option value="not-started">Not Started</option>
            <option value="in-progress">In Progress</option>
            <option value="blocked">Blocked</option>
            <option value="completed">Completed</option>
            <option value="skipped">Skipped</option>
            <option value="in-error">In Error</option>
          </select>
          <button class="btn small" onclick="clearFilters()">Clear Filters</button>
        </div>
      </div>
      
      <table class="table" id="runbookTable">
        <thead>
          <tr>
            <th style="width:40px;"></th>
            <th style="width:60px;">Sequence</th>
            <th style="width:120px;">Strategy</th>
            <th style="width:120px;">Phase</th>
            <th style="width:160px;">Runblock</th>
            <th style="width:180px;">Responsibility</th>
            <th style="width:80px;text-align:center;">Predecessor</th>
            <th style="width:100px;text-align:center;">Status</th>
            <th style="width:60px;text-align:center;">Critical</th>
            <th style="width:120px;text-align:center;">Actions</th>
          </tr>
        </thead>
        <tbody id="runbookBody">
          <!-- Dynamic rows will be added here -->
        </tbody>
      </table>
      
      <div class="btnbar">
        <button class="btn primary" onclick="addRunbookRow()">‚ûï Add Line</button>
        <button class="btn" onclick="clearRunbook()">üóëÔ∏è Clear All</button>
        <div style="margin-left:auto;">
          <input type="file" id="uploadFile" accept=".csv" class="hidden" onchange="uploadExcel(event)">
          <button class="btn" onclick="downloadExcel()">üì• Download CSV</button>
          <button class="btn" onclick="document.getElementById('uploadFile').click()">üì§ Upload CSV</button>
        </div>
      </div>
      
      <div class="info-box">
        <strong>Instructions:</strong><br>
        ‚Ä¢ Use <strong>Search box</strong> to filter runbooks by name, strategy, phase, or responsibility<br>
        ‚Ä¢ <strong>Drag rows</strong> (‚â° icon) to reorder sequence<br>
        ‚Ä¢ Set <strong>Status</strong> for each task: Not Started, In Progress, Blocked, Completed, Skipped, or In Error<br>
        ‚Ä¢ Click <strong>üîÑ Duplicate</strong> to copy a runbook with all settings<br>
        ‚Ä¢ <strong>Keyboard shortcuts:</strong> Ctrl+N (add), Ctrl+D (duplicate), Ctrl+F (search), ? (help)<br>
        ‚Ä¢ <strong>Elapsed time badges</strong> appear on timeline for in-progress tasks<br>
        ‚Ä¢ Mark critical path items with the Critical checkbox<br>
        ‚Ä¢ PLAN controls the planned duration of each runbook<br>
        ‚Ä¢ ACTUAL is automatically populated when status is set to Completed<br>
        ‚Ä¢ Viewer mode users see live progress but cannot make changes<br>
        ‚Ä¢ <strong>Hover over timeline blocks</strong> to see detailed information
      </div>

      <!-- Template Management Section -->
      <div class="template-section">
        <h3>üìã Runbook Templates</h3>
        <p style="font-size:13px;color:var(--sap-muted);margin-bottom:16px;">
          Save your current runbook configuration as a template for future use. Templates are stored in the cloud and can be loaded anytime.
        </p>
        
        <div class="template-controls">
          <div class="template-field">
            <label>Template Name</label>
            <input type="text" id="templateName" placeholder="Enter template name (e.g., 'SAP S/4HANA Standard')" style="width:100%;">
          </div>
          <button class="btn primary" onclick="saveTemplate()">üíæ Save as Template</button>
          <button class="btn" onclick="refreshTemplates()">üîÑ Refresh List</button>
        </div>

        <div class="template-list" id="templateList">
          <div style="padding:20px;text-align:center;color:var(--sap-muted);">
            No templates saved yet. Create your first template above!
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Keyboard Shortcuts Help -->
<div class="keyboard-shortcuts-overlay" id="keyboardShortcutsOverlay" onclick="hideKeyboardShortcuts()"></div>
<div class="keyboard-shortcuts-help" id="keyboardShortcutsHelp">
  <h3 style="margin-top:0;">Keyboard Shortcuts</h3>
  <div class="shortcut-item">
    <span>Add New Runbook</span>
    <span class="shortcut-key">Ctrl + N</span>
  </div>
  <div class="shortcut-item">
    <span>Duplicate Selected Row</span>
    <span class="shortcut-key">Ctrl + D</span>
  </div>
  <div class="shortcut-item">
    <span>Save/Sync</span>
    <span class="shortcut-key">Ctrl + S</span>
  </div>
  <div class="shortcut-item">
    <span>Focus Search</span>
    <span class="shortcut-key">Ctrl + F</span>
  </div>
  <div class="shortcut-item">
    <span>Toggle Full Screen</span>
    <span class="shortcut-key">F</span>
  </div>
  <div class="shortcut-item">
    <span>Show This Help</span>
    <span class="shortcut-key">?</span>
  </div>
  <div class="shortcut-item">
    <span>Close Help</span>
    <span class="shortcut-key">Esc</span>
  </div>
  <div style="margin-top:16px;text-align:center;">
    <button class="btn" onclick="hideKeyboardShortcuts()">Close</button>
  </div>
</div>

<script>
'use strict';

// Password Protection
const APP_PASSWORD = 'downtime2025';
let isAuthenticated = false;

function checkPassword() {
  const input = document.getElementById('passwordInput');
  const error = document.getElementById('passwordError');
  const modal = document.getElementById('passwordModal');
  
  if (input.value === APP_PASSWORD) {
    isAuthenticated = true;
    modal.classList.add('hidden');
    localStorage.setItem('appAuthenticated', 'true');
    initializeApp();
  } else {
    error.textContent = '‚ùå Incorrect password. Please try again.';
    input.value = '';
    input.focus();
  }
}

// Check authentication on load
document.addEventListener('DOMContentLoaded', function() {
  const passwordInput = document.getElementById('passwordInput');
  if (localStorage.getItem('appAuthenticated') === 'true') {
    isAuthenticated = true;
    document.getElementById('passwordModal').classList.add('hidden');
  } else {
    passwordInput.focus();
  }
  
  // Allow Enter key to submit password
  passwordInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      checkPassword();
    }
  });
});

// Initialize Microsoft Teams if running inside Teams
if (typeof microsoftTeams !== 'undefined' && microsoftTeams.app && typeof microsoftTeams.app.initialize === 'function') {
  const validOrigins = ['https://snpcom.sharepoint.com'];
  microsoftTeams.app.initialize(validOrigins).catch(function() {
    console.warn('Teams initialization failed or not running inside Teams');
  });
}

// Global state
window.AppState = {
  runbooks: [],
  downtimeStarted: false,
  downtimeStartTime: null,
  downtimeDuration: 24,
  downtimePaused: false,
  pausedDuration: 0,
  pauseStartTime: null,
  currentDraggedBlock: null,
  dragOffset: 0,
  completionTimes: {},
  isFirstUser: false,
  syncedTimelinePosition: 0,
  renderLock: false,
  messagesOn: false,
  lastRenderTime: 0,
  inputLock: false,
  timelineInputLock: false,
  focusedTimelineInput: null,
  selectedRunbookId: null,
  draggedRowId: null,
  searchQuery: '',
  filterStrategy: '',
  filterStatus: '',
  fullscreenMode: false
};

// Constants
var STRATEGIES = ['Preparation', 'Export', 'Import', 'Quality Gate', 'Conversion', 'Validation'];
var PHASES = ['Tables', 'Delta', 'Checkpoint', 'Finance', 'Logistics', 'PCA Tool', 'MPP', 'Support', 'Collector', 'NZD'];
var TASK_STATUSES = ['not-started', 'in-progress', 'blocked', 'completed', 'skipped', 'in-error'];

// Enhanced Tooltip Functions
let tooltipTimeout;

function showEnhancedTooltip(runbook, event) {
  clearTimeout(tooltipTimeout);
  
  tooltipTimeout = setTimeout(function() {
    const tooltip = document.getElementById('enhancedTooltip');
    if (!tooltip) return;
    
    // Update tooltip content
    document.getElementById('tooltipTitle').textContent = runbook.runblock || 'Unnamed Task';
    document.getElementById('tooltipResponsibility').textContent = runbook.responsibility || 'Not Assigned';
    document.getElementById('tooltipPhase').textContent = runbook.phase || '‚Äî';
    document.getElementById('tooltipStrategy').textContent = runbook.strategy || '‚Äî';
    
    // Update status with icon
    const status = runbook.status || 'not-started';
    const statusText = status.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    document.getElementById('tooltipStatusText').textContent = statusText;
    
    const statusIcon = document.getElementById('tooltipStatusIcon');
    statusIcon.className = 'status-icon ' + status;
    
    // Update icon based on strategy
    const iconMap = {
      'Preparation': 'üîß',
      'Export': 'üì§',
      'Import': 'üì•',
      'Quality Gate': '‚úì',
      'Conversion': 'üîÑ',
      'Validation': '‚úîÔ∏è'
    };
    document.getElementById('tooltipIcon').textContent = iconMap[runbook.strategy] || 'üì¶';
    
    // Position tooltip near cursor
    tooltip.style.left = (event.clientX + 20) + 'px';
    tooltip.style.top = (event.clientY + 20) + 'px';
    
    // Show tooltip
    tooltip.classList.add('show');
  }, 300);
}

function hideEnhancedTooltip() {
  clearTimeout(tooltipTimeout);
  const tooltip = document.getElementById('enhancedTooltip');
  if (tooltip) tooltip.classList.remove('show');
}

// Template Management Functions
window.saveTemplate = async function() {
  const templateName = document.getElementById('templateName');
  if (!templateName.value.trim()) {
    alert('Please enter a template name');
    return;
  }
  
  if (window.AppState.runbooks.length === 0) {
    alert('No runbook data to save. Please add some runbooks first.');
    return;
  }
  
  const template = {
    name: templateName.value.trim(),
    runbooks: window.AppState.runbooks.map(r => ({
      sequence: r.sequence,
      strategy: r.strategy,
      phase: r.phase,
      runblock: r.runblock,
      responsibility: r.responsibility,
      critical: r.critical,
      scheduleHours: r.scheduleHours,
      scheduleMinutes: r.scheduleMinutes,
      durationHours: r.durationHours,
      durationMinutes: r.durationMinutes
    })),
    createdAt: new Date().toISOString(),
    createdBy: document.getElementById('customerName')?.value || 'Unknown'
  };
  
  try {
    // Will be saved via Firebase
    if (window.saveTemplateToFirebase) {
      await window.saveTemplateToFirebase(template);
      templateName.value = '';
      alert('‚úÖ Template saved successfully!');
      refreshTemplates();
    } else {
      alert('‚ö†Ô∏è Template saving not available yet. Please wait for Firebase initialization.');
    }
  } catch (e) {
    console.error('Error saving template:', e);
    alert('‚ùå Error saving template: ' + e.message);
  }
};

window.loadTemplate = async function(templateId) {
  if (!confirm('Load this template? Current runbook data will be replaced.')) {
    return;
  }
  
  try {
    if (window.loadTemplateFromFirebase) {
      const template = await window.loadTemplateFromFirebase(templateId);
      
      window.AppState.runbooks = template.runbooks.map(function(r, idx) {
        return {
          ...r,
          id: Date.now() + Math.random() + idx,
          completed: false,
          actualDuration: null,
          position: 0,
          status: 'not-started'
        };
      });
      
      renderRunbookTable();
      updateTimeline();
      updateCompletionPercentage();
      
      alert('‚úÖ Template loaded successfully!');
    }
  } catch (e) {
    console.error('Error loading template:', e);
    alert('‚ùå Error loading template: ' + e.message);
  }
};

window.deleteTemplate = async function(templateId) {
  if (!confirm('Are you sure you want to delete this template? This cannot be undone.')) {
    return;
  }
  
  try {
    if (window.deleteTemplateFromFirebase) {
      await window.deleteTemplateFromFirebase(templateId);
      alert('‚úÖ Template deleted successfully!');
      refreshTemplates();
    }
  } catch (e) {
    console.error('Error deleting template:', e);
    alert('‚ùå Error deleting template: ' + e.message);
  }
};

window.refreshTemplates = async function() {
  const listContainer = document.getElementById('templateList');
  if (!listContainer) return;
  
  try {
    if (window.loadTemplatesFromFirebase) {
      const templates = await window.loadTemplatesFromFirebase();
      
      if (templates.length === 0) {
        listContainer.innerHTML = '<div style="padding:20px;text-align:center;color:var(--sap-muted);">No templates saved yet. Create your first template above!</div>';
        return;
      }
      
      listContainer.innerHTML = templates.map(function(t) {
        const date = new Date(t.createdAt).toLocaleDateString();
        const runbookCount = t.runbooks.length;
        
        return `
          <div class="template-item">
            <div class="template-info">
              <div class="template-name">${t.name}</div>
              <div class="template-meta">${runbookCount} runbooks ‚Ä¢ Created ${date} by ${t.createdBy}</div>
            </div>
            <div class="template-actions">
              <button class="btn small primary" onclick="loadTemplate('${t.id}')">üìÇ Load</button>
              <button class="btn small danger" onclick="deleteTemplate('${t.id}')">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
  } catch (e) {
    console.error('Error refreshing templates:', e);
    listContainer.innerHTML = '<div style="padding:20px;text-align:center;color:var(--sap-error);">Error loading templates</div>';
  }
};

// NEW: Keyboard Shortcuts Handler
document.addEventListener('keydown', function(e) {
  // Don't trigger shortcuts when typing in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
    // Except for Ctrl+S to save
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      // Force push state if host
      if (window.canWrite && window.canWrite()) {
        console.log('Manual save triggered');
      }
      return;
    }
    return;
  }
  
  // Ctrl+N: Add new runbook
  if (e.ctrlKey && e.key === 'n') {
    e.preventDefault();
    window.addRunbookRow();
  }
  
  // Ctrl+D: Duplicate selected row
  if (e.ctrlKey && e.key === 'd') {
    e.preventDefault();
    if (window.AppState.selectedRunbookId) {
      window.duplicateRunbook(window.AppState.selectedRunbookId);
    }
  }
  
  // Ctrl+F: Focus search
  if (e.ctrlKey && e.key === 'f') {
    e.preventDefault();
    var searchBox = document.getElementById('searchRunbooks');
    if (searchBox) {
      searchBox.focus();
      searchBox.select();
    }
  }
  
  // F: Toggle full screen mode
  if (e.key === 'f' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
    e.preventDefault();
    toggleFullscreenMode();
  }
  
  // ?: Show keyboard shortcuts help
  if (e.key === '?' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
    e.preventDefault();
    showKeyboardShortcuts();
  }
  
  // Esc: Close keyboard shortcuts help or exit fullscreen
  if (e.key === 'Escape') {
    hideKeyboardShortcuts();
    if (window.AppState.fullscreenMode) {
      toggleFullscreenMode();
    }
  }
});

// NEW: Full Screen Mode Functions
function toggleFullscreenMode() {
  window.AppState.fullscreenMode = !window.AppState.fullscreenMode;
  
  if (window.AppState.fullscreenMode) {
    document.body.classList.add('fullscreen-mode');
    updateFullscreenCustomerInfo();
  } else {
    document.body.classList.remove('fullscreen-mode');
  }
  
  updateFullscreenButton(window.AppState.fullscreenMode);
  
  // Trigger timeline update to adjust for new dimensions
  setTimeout(function() {
    if (typeof window.updateTimeline === 'function') {
      window.updateTimeline();
    }
  }, 100);
}

function updateFullscreenButton(isFullscreen) {
  var icon = document.getElementById('fullscreenIcon');
  var text = document.getElementById('fullscreenText');
  var btn = document.getElementById('fullscreenToggle');
  
  if (icon) icon.textContent = isFullscreen ? '‚õ∂' : '‚õ∂';
  if (text) text.textContent = isFullscreen ? 'Exit Focus' : 'Focus';
  if (btn) {
    if (isFullscreen) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  }
}

function updateFullscreenCustomerInfo() {
  var customerNameEl = document.getElementById('fullscreenCustomerName');
  var transformCycleEl = document.getElementById('fullscreenTransformCycle');
  
  var customerName = document.getElementById('customerName');
  var transformCycle = document.getElementById('transformCycle');
  
  if (customerNameEl && customerName) {
    customerNameEl.textContent = customerName.value || 'Not Set';
  }
  
  if (transformCycleEl && transformCycle) {
    transformCycleEl.textContent = transformCycle.value || 'Not Set';
  }
}

window.toggleFullscreenMode = toggleFullscreenMode;

// NEW: Keyboard Shortcuts Help Functions
function showKeyboardShortcuts() {
  document.getElementById('keyboardShortcutsOverlay').classList.add('show');
  document.getElementById('keyboardShortcutsHelp').classList.add('show');
}

function hideKeyboardShortcuts() {
  document.getElementById('keyboardShortcutsOverlay').classList.remove('show');
  document.getElementById('keyboardShortcutsHelp').classList.remove('show');
}

window.showKeyboardShortcuts = showKeyboardShortcuts;
window.hideKeyboardShortcuts = hideKeyboardShortcuts;

// NEW: Search/Filter Functions
window.filterRunbooks = function() {
  var searchQuery = document.getElementById('searchRunbooks').value.toLowerCase();
  var filterStrategy = document.getElementById('filterStrategy').value;
  var filterStatus = document.getElementById('filterStatus').value;
  
  window.AppState.searchQuery = searchQuery;
  window.AppState.filterStrategy = filterStrategy;
  window.AppState.filterStatus = filterStatus;
  
  renderRunbookTable();
  updateTimeline();
};

window.clearFilters = function() {
  document.getElementById('searchRunbooks').value = '';
  document.getElementById('filterStrategy').value = '';
  document.getElementById('filterStatus').value = '';
  window.AppState.searchQuery = '';
  window.AppState.filterStrategy = '';
  window.AppState.filterStatus = '';
  renderRunbookTable();
  updateTimeline();
};

// NEW: Get Filtered Runbooks
function getFilteredRunbooks() {
  return window.AppState.runbooks.filter(function(runbook) {
    // Search filter
    if (window.AppState.searchQuery) {
      var searchMatch = (runbook.runblock || '').toLowerCase().includes(window.AppState.searchQuery) ||
                       (runbook.responsibility || '').toLowerCase().includes(window.AppState.searchQuery) ||
                       (runbook.strategy || '').toLowerCase().includes(window.AppState.searchQuery) ||
                       (runbook.phase || '').toLowerCase().includes(window.AppState.searchQuery);
      if (!searchMatch) return false;
    }
    
    // Strategy filter
    if (window.AppState.filterStrategy && runbook.strategy !== window.AppState.filterStrategy) {
      return false;
    }
    
    // Status filter
    if (window.AppState.filterStatus) {
      var status = runbook.status || 'not-started';
      if (status !== window.AppState.filterStatus) {
        return false;
      }
    }
    
    return true;
  });
}

// NEW: Duplicate Runbook Function
window.duplicateRunbook = function(id) {
  var original = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (!original) return;
  
  var duplicate = {
    id: Date.now() + Math.random(),
    sequence: window.AppState.runbooks.length + 1,
    strategy: original.strategy,
    phase: original.phase,
    runblock: original.runblock + ' (Copy)',
    responsibility: original.responsibility,
    critical: original.critical,
    scheduleHours: original.scheduleHours,
    scheduleMinutes: original.scheduleMinutes,
    durationHours: original.durationHours,
    durationMinutes: original.durationMinutes,
    completed: false,
    actualDuration: null,
    position: 0,
    status: 'not-started'
  };
  
  window.AppState.runbooks.push(duplicate);
  renderRunbookTable();
  updateTimeline();
  updateCompletionPercentage();
};

// NEW: Update Elapsed Time for In-Progress Tasks
function updateElapsedTimes() {
  if (!window.AppState.downtimeStarted || !window.AppState.downtimeStartTime) return;
  
  var now = new Date();
  var startTime = new Date(window.AppState.downtimeStartTime);
  
  window.AppState.runbooks.forEach(function(runbook) {
    if (runbook.status === 'in-progress' && !runbook.completed) {
      var scheduledOffset = runbook.scheduleHours * 3600000 + runbook.scheduleMinutes * 60000;
      var taskStart = new Date(startTime.getTime() + scheduledOffset);
      
      if (now >= taskStart) {
        var elapsedMs = now - taskStart - window.AppState.pausedDuration;
        var elapsedHours = Math.floor(elapsedMs / 3600000);
        var elapsedMinutes = Math.floor((elapsedMs % 3600000) / 60000);
        
        // Update elapsed time badge on timeline
        var block = document.querySelector('.timeline-block[data-runbook-id="' + runbook.id + '"]');
        if (block) {
          var existingBadge = block.querySelector('.elapsed-time-badge');
          if (!existingBadge) {
            var badge = document.createElement('div');
            badge.className = 'elapsed-time-badge';
            block.appendChild(badge);
            existingBadge = badge;
          }
          existingBadge.textContent = 'Elapsed: ' + String(elapsedHours).padStart(2,'0') + ':' + String(elapsedMinutes).padStart(2,'0');
        }
      }
    }
  });
}

// Update clock to also update elapsed times
setInterval(function() {
  if (window.AppState.downtimeStarted && !window.AppState.downtimePaused) {
    updateElapsedTimes();
  }
}, 1000);

// NEW: Dark Mode Functions
function initDarkMode() {
  var darkMode = localStorage.getItem('darkMode') === 'true';
  if (darkMode) {
    document.body.classList.add('dark-mode');
    updateDarkModeButton(true);
  }
}

function toggleDarkMode() {
  var isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', isDark);
  updateDarkModeButton(isDark);
}

function updateDarkModeButton(isDark) {
  var icon = document.getElementById('darkModeIcon');
  var text = document.getElementById('darkModeText');
  if (icon) icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  if (text) text.textContent = isDark ? 'Light' : 'Dark';
}

// NEW: Completion Percentage Functions
function updateCompletionPercentage() {
  var totalTasks = window.AppState.runbooks.length;
  var completedTasks = window.AppState.runbooks.filter(function(r) { return r.completed; }).length;
  var percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
  
  var percentageEl = document.getElementById('completionPercentage');
  var progressBar = document.getElementById('progressBarFill');
  
  if (percentageEl) percentageEl.textContent = percentage + '%';
  if (progressBar) progressBar.style.width = percentage + '%';
}

// NEW: Recent Customers Functions
function getRecentCustomers() {
  var stored = localStorage.getItem('recentCustomers');
  return stored ? JSON.parse(stored) : [];
}

function addRecentCustomer(name) {
  if (!name || name.trim().length === 0) return;
  
  var recent = getRecentCustomers();
  // Remove if already exists
  recent = recent.filter(function(c) { return c !== name; });
  // Add to beginning
  recent.unshift(name);
  // Keep only last 10
  recent = recent.slice(0, 10);
  
  localStorage.setItem('recentCustomers', JSON.stringify(recent));
  updateRecentCustomersDropdown();
}

function updateRecentCustomersDropdown() {
  var dropdown = document.getElementById('recentCustomersDropdown');
  if (!dropdown) return;
  
  var recent = getRecentCustomers();
  
  if (recent.length === 0) {
    dropdown.innerHTML = '<div class="recent-customer-item-empty">No recent customers</div>';
  } else {
    dropdown.innerHTML = recent.map(function(name) {
      return '<div class="recent-customer-item" onclick="selectRecentCustomer(\'' + 
             name.replace(/'/g, "\\'") + '\')">' + name + '</div>';
    }).join('');
  }
}

function toggleRecentCustomersDropdown() {
  var dropdown = document.getElementById('recentCustomersDropdown');
  if (!dropdown) return;
  
  dropdown.classList.toggle('show');
}

window.selectRecentCustomer = function(name) {
  var input = document.getElementById('customerName');
  if (input) {
    input.value = name;
    // Trigger change event for Firebase sync
    var event = new Event('change', { bubbles: true });
    input.dispatchEvent(event);
  }
  
  var dropdown = document.getElementById('recentCustomersDropdown');
  if (dropdown) dropdown.classList.remove('show');
  
  // Update fullscreen info if in fullscreen mode
  if (window.AppState.fullscreenMode) {
    updateFullscreenCustomerInfo();
  }
};

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  var btn = document.getElementById('recentCustomersBtn');
  var dropdown = document.getElementById('recentCustomersDropdown');
  var input = document.getElementById('customerName');
  
  if (dropdown && !dropdown.contains(e.target) && e.target !== btn && e.target !== input) {
    dropdown.classList.remove('show');
  }
});

// Browser close confirmation
window.addEventListener('beforeunload', function (e) {
  if (window.canWrite && window.canWrite() && window.AppState.downtimeStarted) {
    var confirmationMessage = 'You have an active downtime session. Are you sure you want to leave?';
    e.returnValue = confirmationMessage;
    return confirmationMessage;
  }
});

// Initialize application
document.addEventListener('DOMContentLoaded', function() {
  if (!isAuthenticated) return;
  
  initializeApp();
  initDarkMode();
  updateRecentCustomersDropdown();
  
  document.body.classList.add('messages-off');
  if (window.AppState) window.AppState.messagesOn = false;
  updateClock();
  setInterval(updateClock, 1000);
  
  // Dark mode toggle listener
  var darkModeToggle = document.getElementById('darkModeToggle');
  if (darkModeToggle) {
    darkModeToggle.addEventListener('click', toggleDarkMode);
  }
  
  // Full screen toggle listener
  var fullscreenToggle = document.getElementById('fullscreenToggle');
  if (fullscreenToggle) {
    fullscreenToggle.addEventListener('click', toggleFullscreenMode);
  }
  
  // Recent customers button listener
  var recentBtn = document.getElementById('recentCustomersBtn');
  if (recentBtn) {
    recentBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      toggleRecentCustomersDropdown();
    });
  }
  
  // Customer name change listener
  var customerNameInput = document.getElementById('customerName');
  if (customerNameInput) {
    customerNameInput.addEventListener('change', function() {
      if (this.value && this.value.trim().length > 0) {
        addRecentCustomer(this.value.trim());
      }
      // Update fullscreen info if in fullscreen mode
      if (window.AppState.fullscreenMode) {
        updateFullscreenCustomerInfo();
      }
    });
    
    customerNameInput.addEventListener('focus', function() {
      window.AppState.inputLock = true;
    });
    customerNameInput.addEventListener('blur', function() {
      setTimeout(function() {
        window.AppState.inputLock = false;
      }, 500);
    });
  }
  
  // Protect transform cycle input from Firebase overwrites
  var transformCycleInput = document.getElementById('transformCycle');
  if (transformCycleInput) {
    transformCycleInput.addEventListener('change', function() {
      // Update fullscreen info if in fullscreen mode
      if (window.AppState.fullscreenMode) {
        updateFullscreenCustomerInfo();
      }
    });
    
    transformCycleInput.addEventListener('focus', function() {
      window.AppState.inputLock = true;
    });
    transformCycleInput.addEventListener('blur', function() {
      setTimeout(function() {
        window.AppState.inputLock = false;
      }, 500);
    });
  }
  
  var toggleBtn = document.getElementById('messageToggleBtn');
  if (toggleBtn) {
    var applyState = function() {
      var on = !!(window.AppState && window.AppState.messagesOn);
      document.body.classList.toggle('messages-off', !on);
      toggleBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
      toggleBtn.textContent = on ? 'Messages: On' : 'Messages: Off';
      if (typeof displayValidationWarnings === 'function') { 
        try { 
          displayValidationWarnings(); 
        } catch(e){
          console.error('Error displaying warnings:', e);
        } 
      }
    };
    applyState();
    toggleBtn.addEventListener('click', function() {
      window.AppState = window.AppState || {};
      window.AppState.messagesOn = !window.AppState.messagesOn;
      applyState();
    });
  }
});

function initializeApp() {
  updateTimeline();
  setupStartTimeInputs();
  calculateEndTime();
  updateCompletionPercentage();
  refreshTemplates();
}

function setupStartTimeInputs() {
  if (!window.AppState.downtimeStarted) {
    var startInput = document.getElementById('startTimeInput');
    var startDisplay = document.getElementById('startTimeDisplay');
    var durationInput = document.getElementById('currentDurationInput');
    var durationDisplay = document.getElementById('currentDurationDisplay');
    
    if (startInput) startInput.style.display = 'block';
    if (startDisplay) startDisplay.style.display = 'none';
    if (durationInput) durationInput.style.display = 'block';
    if (durationDisplay) durationDisplay.style.display = 'none';
    
    // Set default start time
    var now = new Date();
    var hours = String(now.getHours()).padStart(2, '0');
    var minutes = String(now.getMinutes()).padStart(2, '0');
    if (startInput) startInput.value = hours + ':' + minutes;
  }
}

function calculateEndTime() {
  var duration = parseInt(document.getElementById('downtimeDuration').value) || 24;
  var startTimeInput = document.getElementById('startTimeInput');
  var endTimeDisplay = document.getElementById('endTimeDisplay');
  
  if (!window.AppState.downtimeStarted && startTimeInput && startTimeInput.value) {
    var timeParts = startTimeInput.value.split(':').map(Number);
    var hours = timeParts[0];
    var minutes = timeParts[1];
    var startDate = new Date();
    startDate.setHours(hours, minutes, 0, 0);
    
    var endDate = new Date(startDate.getTime() + duration * 3600000);
    updateEndTimeDisplay(endDate, duration);
  } else if (window.AppState.downtimeStarted && window.AppState.downtimeStartTime) {
    var endDate = new Date(window.AppState.downtimeStartTime.getTime() + duration * 3600000);
    updateEndTimeDisplay(endDate, duration);
  }
}

function updateEndTimeDisplay(endDate, duration) {
  var endTimeDisplay = document.getElementById('endTimeDisplay');
  if (!endTimeDisplay) return;
  
  var endHours = String(endDate.getHours()).padStart(2, '0');
  var endMinutes = String(endDate.getMinutes()).padStart(2, '0');
  var endSeconds = String(endDate.getSeconds()).padStart(2, '0');
  
  var displayText = endHours + ':' + endMinutes + ':' + endSeconds;
  
  var daysDiff = Math.floor(duration / 24);
  if (daysDiff > 0) {
    displayText += ' (+' + daysDiff + ' day' + (daysDiff > 1 ? 's' : '') + ')';
  }
  
  endTimeDisplay.textContent = displayText;
}

function updateClock() {
  var now = new Date();
  var timeElement = document.getElementById('currentTime');
  if (timeElement) {
    timeElement.textContent = now.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit', 
      second: '2-digit', 
      hour12: false 
    });
  }
  
  // Only update duration if downtime has actually started
  if (window.AppState.downtimeStarted && window.AppState.downtimeStartTime && !window.AppState.downtimePaused) {
    updateDuration();
    updateProgressIndicators();
  } else if (!window.AppState.downtimeStarted) {
    // Ensure duration stays at 00:00:00 if not started
    var durationDisplay = document.getElementById('currentDurationDisplay');
    if (durationDisplay && durationDisplay.textContent !== '00:00:00') {
      durationDisplay.textContent = '00:00:00';
    }
  }
}

function updateDuration() {
  if (!window.AppState.downtimeStartTime) return;
  
  var now = new Date();
  var elapsed = now - window.AppState.downtimeStartTime - window.AppState.pausedDuration;
  var hours = Math.floor(elapsed / 3600000);
  var minutes = Math.floor((elapsed % 3600000) / 60000);
  var seconds = Math.floor((elapsed % 60000) / 1000);
  
  var durationDisplay = document.getElementById('currentDurationDisplay');
  if (durationDisplay) {
    durationDisplay.textContent = 
      String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
  }
}

// Data Validation Functions
function validateSchedules() {
  var warnings = [];
  var criticalPathItems = window.AppState.runbooks.filter(function(r) { return r.critical; });
  
  // Check for overlapping critical path items
  for (var i = 0; i < criticalPathItems.length; i++) {
    for (var j = i + 1; j < criticalPathItems.length; j++) {
      var item1 = criticalPathItems[i];
      var item2 = criticalPathItems[j];
      
      var start1 = item1.scheduleHours + item1.scheduleMinutes / 60;
      var end1 = start1 + item1.durationHours + item1.durationMinutes / 60;
      var start2 = item2.scheduleHours + item2.scheduleMinutes / 60;
      var end2 = start2 + item2.durationHours + item2.durationMinutes / 60;
      
      if ((start1 < end2 && end1 > start2)) {
        warnings.push('Critical path conflict: "' + item1.runblock + '" and "' + item2.runblock + '" overlap');
      }
    }
  }
  
  // Check for unrealistic durations
  window.AppState.runbooks.forEach(function(runbook) {
    var duration = runbook.durationHours + runbook.durationMinutes / 60;
    if (duration > 8) {
      warnings.push('Warning: "' + runbook.runblock + '" has duration > 8 hours');
    }
  });
  
  // Check for tasks extending beyond downtime window
  window.AppState.runbooks.forEach(function(runbook) {
    var start = runbook.scheduleHours + runbook.scheduleMinutes / 60;
    var duration = runbook.durationHours + runbook.durationMinutes / 60;
    if (start + duration > window.AppState.downtimeDuration) {
      warnings.push('Schedule conflict: "' + runbook.runblock + '" extends beyond downtime window');
    }
  });
  
  return warnings;
}

function displayValidationWarnings() {
  if (!window.AppState.messagesOn) { 
    var container = document.getElementById('validationMessages'); 
    if (container) container.innerHTML=''; 
    return; 
  }
  var warnings = validateSchedules();
  var container = document.getElementById('validationMessages');
  
  if (!container) return;
  
  container.innerHTML = '';
  if (warnings.length > 0) {
    var warningDiv = document.createElement('div');
    warningDiv.className = 'validation-warning';
    warningDiv.innerHTML = '<strong>‚ö†Ô∏è Validation Warnings:</strong><br>' + warnings.join('<br>');
    container.appendChild(warningDiv);
  }
}

// Check if element is actively being edited
function isElementActive(element) {
  var active = document.activeElement;
  return active && (active === element || element.contains(active));
}

// Runbook Management Functions
window.addRunbookRow = function() {
  var runbook = {
    id: Date.now() + Math.random(),
    sequence: window.AppState.runbooks.length + 1,
    strategy: STRATEGIES[0],
    phase: PHASES[0],
    runblock: '',
    responsibility: '',
    predecessor: '',
    critical: false,
    scheduleHours: 0,
    scheduleMinutes: 0,
    durationHours: 1,
    durationMinutes: 0,
    completed: false,
    actualDuration: null,
    position: 0,
    status: 'not-started'
  };
  
  window.AppState.runbooks.push(runbook);
  renderRunbookTable();
  updateTimeline();
  updateCompletionPercentage();
};

function renderRunbookTable() {
  if (window.AppState.renderLock) return;
  
  var tbody = document.getElementById('runbookBody');
  if (!tbody) return;
  
  // Don't re-render if user is actively editing ANY input
  var activeElement = document.activeElement;
  if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
    return;
  }
  
  // Throttle renders to prevent flickering
  var now = Date.now();
  if (now - window.AppState.lastRenderTime < 100) {
    return;
  }
  window.AppState.lastRenderTime = now;
  
  window.AppState.renderLock = true;
  
  try {
    // Get filtered runbooks
    var filteredRunbooks = getFilteredRunbooks();
    filteredRunbooks.sort(function(a, b) { return a.sequence - b.sequence; });
    
    // Clear tbody
    tbody.innerHTML = '';
    
    // Check if we're the host and can write
    var canEdit = !window.canWrite || window.canWrite();
    
    // Create rows for filtered runbooks
    filteredRunbooks.forEach(function(runbook) {
      var row = document.createElement('tr');
      row.dataset.runbookId = runbook.id;
      row.draggable = canEdit;
      
      // Add drag events
      if (canEdit) {
        row.addEventListener('dragstart', handleRowDragStart);
        row.addEventListener('dragend', handleRowDragEnd);
        row.addEventListener('dragover', handleRowDragOver);
        row.addEventListener('drop', handleRowDrop);
        row.addEventListener('click', function() {
          window.AppState.selectedRunbookId = runbook.id;
          document.querySelectorAll('#runbookBody tr').forEach(function(r) {
            r.style.backgroundColor = '';
          });
          row.style.backgroundColor = 'rgba(10,110,209,0.1)';
        });
      }
      
      var editingDisabled = canEdit ? '' : 'disabled';
      
      var strategyOptions = STRATEGIES.map(function(s) {
        return '<option value="' + s + '" ' + (runbook.strategy === s ? 'selected' : '') + '>' + s + '</option>';
      }).join('');
      
      var phaseOptions = PHASES.map(function(p) {
        return '<option value="' + p + '" ' + (runbook.phase === p ? 'selected' : '') + '>' + p + '</option>';
      }).join('');
      
      var statusOptions = [
        {value: 'not-started', label: 'Not Started'},
        {value: 'in-progress', label: 'In Progress'},
        {value: 'blocked', label: 'Blocked'},
        {value: 'completed', label: 'Completed'},
        {value: 'skipped', label: 'Skipped'},
        {value: 'in-error', label: 'In Error'}
      ].map(function(s) {
        var selected = (runbook.status || 'not-started') === s.value ? 'selected' : '';
        return '<option value="' + s.value + '" ' + selected + '>' + s.label + '</option>';
      }).join('');
      
      row.innerHTML = 
        '<td style="padding:4px;"><span class="drag-handle" title="Drag to reorder">‚â°</span></td>' +
        '<td>' +
        '<input type="number" min="1" max="30" value="' + runbook.sequence + '" ' +
        'style="width:60px;text-align:center;" onchange="updateSequence(' + runbook.id + ', this.value)" ' + editingDisabled + '>' +
        '</td>' +
        '<td>' +
        '<select onchange="updateStrategy(' + runbook.id + ', this.value)" ' + editingDisabled + '>' +
        strategyOptions +
        '</select>' +
        '</td>' +
        '<td>' +
        '<select onchange="updatePhase(' + runbook.id + ', this.value)" ' + editingDisabled + '>' +
        phaseOptions +
        '</select>' +
        '</td>' +
        '<td>' +
        '<input type="text" value="' + (runbook.runblock || '') + '" placeholder="Enter runblock name" ' +
        'maxlength="50" style="width:100%;" ' +
        'onchange="updateRunblock(' + runbook.id + ', this.value)" ' + editingDisabled + '>' +
        '</td>' +
        '<td>' +
        '<input type="text" value="' + (runbook.responsibility || '') + '" placeholder="Enter responsibility" ' +
        'maxlength="40" style="width:100%;" ' +
        'onchange="updateResponsibility(' + runbook.id + ', this.value)" ' + editingDisabled + '>' +
        '</td>' +
        '<td class="center">' +
        '<input type="text" value="' + (runbook.predecessor || '') + '" placeholder="Seq#" ' +
        'maxlength="10" style="width:70px;text-align:center;" ' +
        'onchange="updatePredecessor(' + runbook.id + ', this.value)" ' + editingDisabled + ' title="Enter sequence number of task that must complete first">' +
        '</td>' +
        '<td class="center">' +
        '<select class="status-select" onchange="updateStatus(' + runbook.id + ', this.value)" ' + editingDisabled + '>' +
        statusOptions +
        '</select>' +
        '</td>' +
        '<td class="critical-cell center">' +
        '<input type="checkbox" class="critical-checkbox" ' +
        (runbook.critical ? 'checked' : '') + ' ' +
        'onchange="updateCritical(' + runbook.id + ', this.checked)" ' + editingDisabled + '>' +
        '</td>' +
        '<td class="center">' +
        '<button class="btn small" onclick="duplicateRunbook(' + runbook.id + ')" ' + editingDisabled + ' title="Duplicate">üîÑ</button> ' +
        '<button class="btn small danger" onclick="removeRunbook(' + runbook.id + ')" ' + editingDisabled + '>Remove</button>' +
        '</td>';
      
      tbody.appendChild(row);
    });
    
  } finally {
    window.AppState.renderLock = false;
  }
}

// NEW: Drag and Drop Row Reordering Functions
function handleRowDragStart(e) {
  window.AppState.draggedRowId = parseFloat(e.currentTarget.dataset.runbookId);
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleRowDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('#runbookBody tr').forEach(function(row) {
    row.classList.remove('drag-over');
  });
}

function handleRowDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  
  var draggedId = window.AppState.draggedRowId;
  var targetId = parseFloat(e.currentTarget.dataset.runbookId);
  
  if (draggedId !== targetId) {
    e.currentTarget.classList.add('drag-over');
  }
}

function handleRowDrop(e) {
  e.preventDefault();
  
  var draggedId = window.AppState.draggedRowId;
  var targetId = parseFloat(e.currentTarget.dataset.runbookId);
  
  if (draggedId === targetId) return;
  
  var draggedRunbook = window.AppState.runbooks.find(function(r) { return r.id === draggedId; });
  var targetRunbook = window.AppState.runbooks.find(function(r) { return r.id === targetId; });
  
  if (!draggedRunbook || !targetRunbook) return;
  
  // Swap sequences
  var tempSeq = draggedRunbook.sequence;
  draggedRunbook.sequence = targetRunbook.sequence;
  targetRunbook.sequence = tempSeq;
  
  // Re-render
  setTimeout(function() {
    renderRunbookTable();
    updateTimeline();
  }, 10);
}

// NEW: Update Status Function
window.updateStatus = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.status = value;
    
    // Auto-update completed flag
    if (value === 'completed') {
      runbook.completed = true;
      // Calculate actual duration if downtime is running
      if (window.AppState.downtimeStarted && window.AppState.downtimeStartTime && !runbook.actualDuration) {
        var now = new Date();
        var startTime = new Date(window.AppState.downtimeStartTime);
        var scheduledOffset = runbook.scheduleHours * 3600000 + runbook.scheduleMinutes * 60000;
        var taskStart = new Date(startTime.getTime() + scheduledOffset);
        
        var actualMs = now - taskStart - window.AppState.pausedDuration;
        var actualHours = Math.floor(actualMs / 3600000);
        var actualMinutes = Math.floor((actualMs % 3600000) / 60000);
        
        runbook.actualDuration = String(Math.max(0, actualHours)).padStart(2,'0') + ':' + String(Math.max(0, actualMinutes)).padStart(2,'0');
      }
    } else {
      runbook.completed = false;
    }
    
    updateCompletionPercentage();
    setTimeout(function() { updateTimeline(); }, 100);
  }
};

window.updateSequence = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.sequence = parseInt(value) || 1;
    setTimeout(function() {
      renderRunbookTable();
      updateTimeline();
      displayValidationWarnings();
    }, 100);
  }
};

window.updateStrategy = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.strategy = value;
    setTimeout(function() { updateTimeline(); }, 100);
  }
};

window.updatePhase = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.phase = value;
    setTimeout(function() { updateTimeline(); }, 100);
  }
};

window.updateRunblock = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.runblock = value;
    setTimeout(function() { updateTimeline(); }, 100);
  }
};

window.updateResponsibility = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.responsibility = value;
  }
}

// NEW: Update Predecessor Function
window.updatePredecessor = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.predecessor = value.trim();
    updateTimeline();
  }
};

window.updateCritical = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.critical = value;
    setTimeout(function() {
      updateTimeline();
      displayValidationWarnings();
    }, 100);
  }
};

window.removeRunbook = function(id) {
  window.AppState.runbooks = window.AppState.runbooks.filter(function(r) { return r.id !== id; });
  renderRunbookTable();
  updateTimeline();
  displayValidationWarnings();
  updateCompletionPercentage();
};

window.clearRunbook = function() {
  if (confirm('Are you sure you want to clear all runbook entries?')) {
    window.AppState.runbooks = [];
    renderRunbookTable();
    updateTimeline();
    updateCompletionPercentage();
  }
};

// Timeline Functions
window.updateTimeline = function() {
  var duration = parseInt(document.getElementById('downtimeDuration').value) || 24;
  window.AppState.downtimeDuration = duration;
  
  generateTimeScale(duration);
  generateTimelineRows();
  displayValidationWarnings();

  var finishLine = document.getElementById('finishLine');
  if (finishLine) {
    var pixelsPerHour = 60;
    finishLine.style.left = (duration * pixelsPerHour) + 'px';
    finishLine.style.display = 'block';
  }
  
  // Update progress if running
  if (window.AppState.downtimeStarted) {
    updateProgressIndicators();
  }
};

function generateTimeScale(hours) {
  var scale = document.getElementById('timelineScale');
  if (!scale) return;
  
  scale.innerHTML = '';
  
  var pixelsPerHour = 60;
  var totalWidth = hours * pixelsPerHour;
  scale.style.width = totalWidth + 'px';
  
  for (var h = 0; h <= hours; h++) {
    var marker = document.createElement('div');
    marker.className = 'timeline-hour';
    marker.style.left = (h * pixelsPerHour) + 'px';
    marker.textContent = h + 'h';
    scale.appendChild(marker);
  }
}

function generateTimelineRows() {
  var trackContainer = document.getElementById('timelineRows');
  var controlsContainer = document.getElementById('timelineControlsRows');
  
  if (!trackContainer || !controlsContainer) return;
  
  // Don't regenerate if user is editing timeline inputs
  if (window.AppState.timelineInputLock) {
    return;
  }
  
  // Use filtered runbooks for timeline
  var visibleRunbooks = getFilteredRunbooks()
    .filter(function(rb) { return rb && rb.runblock && rb.runblock.trim().length > 0; })
    .sort(function(a, b) { return a.sequence - b.sequence; });

  // Clear and regenerate track rows
  trackContainer.innerHTML = '';
  visibleRunbooks.forEach(function(runbook, index) {
    var trackRow = createTimelineRow(runbook, index);
    trackContainer.appendChild(trackRow);
  });
  
  // Update or create control rows (don't recreate if already exists)
  var existingRows = Array.from(controlsContainer.querySelectorAll('.timeline-control-row'));
  
  visibleRunbooks.forEach(function(runbook, index) {
    var existingRow = existingRows[index];
    
    if (existingRow) {
      // Update existing row without recreating inputs
      updateTimelineControlRow(existingRow, runbook);
    } else {
      // Create new row
      var controlRow = createTimelineControlRow(runbook);
      controlsContainer.appendChild(controlRow);
    }
  });
  
  // Remove extra rows
  while (controlsContainer.children.length > visibleRunbooks.length) {
    controlsContainer.removeChild(controlsContainer.lastChild);
  }
}

// NEW: Calculate block positions considering predecessors
function calculateBlockPositions() {
  var positions = {};
  var resolved = new Set();
  
  // Create a map for quick lookup by sequence
  var runbooksMap = {};
  window.AppState.runbooks.forEach(function(rb) {
    runbooksMap[rb.sequence] = rb;
  });
  
  // Resolve positions recursively
  function resolvePosition(rb) {
    if (resolved.has(rb.id)) {
      return positions[rb.id];
    }
    
    var scheduleTimeHours = (rb.scheduleHours || 0) + (rb.scheduleMinutes || 0) / 60;
    var durationTimeHours = (rb.durationHours || 1) + (rb.durationMinutes || 0) / 60;
    var startTime = scheduleTimeHours;
    
    // Check if there's a predecessor
    if (rb.predecessor) {
      var predSeq = parseInt(rb.predecessor);
      if (!isNaN(predSeq)) {
        var predecessor = null;
        // Find predecessor by sequence
        for (var i = 0; i < window.AppState.runbooks.length; i++) {
          if (window.AppState.runbooks[i].sequence === predSeq) {
            predecessor = window.AppState.runbooks[i];
            break;
          }
        }
        
        if (predecessor && predecessor.id !== rb.id) {
          // Resolve predecessor first (recursive)
          var predPos = resolvePosition(predecessor);
          var predDuration = (predecessor.durationHours || 1) + (predecessor.durationMinutes || 0) / 60;
          var predEndTime = predPos.start + predDuration;
          // Start after predecessor ends
          startTime = Math.max(startTime, predEndTime);
        }
      }
    }
    
    positions[rb.id] = {
      start: startTime,
      end: startTime + durationTimeHours
    };
    resolved.add(rb.id);
    
    return positions[rb.id];
  }
  
  // Resolve all runbooks
  window.AppState.runbooks.forEach(function(rb) {
    if (!resolved.has(rb.id)) {
      resolvePosition(rb);
    }
  });
  
  return positions;
}

function createTimelineRow(runbook, index) {
  var row = document.createElement('div');
  row.className = 'timeline-row';
  
  if (runbook.critical) {
    row.style.borderLeft = '3px solid #ff0000';
    row.style.background = 'linear-gradient(90deg, rgba(255,0,0,0.05) 0%, transparent 10%)';
  }
  
  var track = document.createElement('div');
  track.className = 'timeline-track';
  track.dataset.runbookId = runbook.id;
  
  var pixelsPerHour = 60;
  var totalWidth = window.AppState.downtimeDuration * pixelsPerHour;
  track.style.width = totalWidth + 'px';

  var isQualityGate = (runbook.strategy === 'Quality Gate');
  
  // Calculate position considering predecessors
  var blockPositions = calculateBlockPositions();
  var pos = blockPositions[runbook.id];
  var startPos = pos ? pos.start : (runbook.scheduleHours + (runbook.scheduleMinutes / 60));
  var startX = startPos * pixelsPerHour;

  if (isQualityGate) {
    var diamond = document.createElement('div');
    diamond.className = 'quality-diamond';
    diamond.dataset.runbookId = runbook.id;
    diamond.style.left = Math.max(0, startX - 7) + 'px';
    if (runbook.completed) {
      diamond.style.opacity = '0.5';
      diamond.style.filter = 'grayscale(100%)';
    }
    if (runbook.critical) {
      diamond.style.boxShadow = '0 0 8px rgba(255, 0, 0, 0.6)';
    }
    
    // Add tooltip events
    diamond.addEventListener('mouseenter', function(e) {
      showEnhancedTooltip(runbook, e);
    });
    diamond.addEventListener('mousemove', function(e) {
      var tooltip = document.getElementById('enhancedTooltip');
      if (tooltip && tooltip.classList.contains('show')) {
        tooltip.style.left = (e.clientX + 20) + 'px';
        tooltip.style.top = (e.clientY + 20) + 'px';
      }
    });
    diamond.addEventListener('mouseleave', hideEnhancedTooltip);
    
    track.appendChild(diamond);
    
    // Add horizontal label to the RIGHT of diamond (positioned relative to track, not diamond)
    var label = document.createElement('div');
    label.className = 'quality-gate-label';
    label.textContent = runbook.runblock;
    label.title = runbook.runblock + ' - ' + runbook.phase;
    label.style.position = 'absolute';
    label.style.left = Math.max(0, startX + 10) + 'px';
    label.style.top = '50%';
    label.style.transform = 'translateY(-50%)';
    track.appendChild(label);
  } else {
    var block = createTimelineBlock(runbook);
    track.appendChild(block);
  }

  row.appendChild(track);
  track.addEventListener('dragover', handleDragOver);
  track.addEventListener('drop', handleDrop);
  return row;
}

function createTimelineControlRow(runbook) {
  var row = document.createElement('div');
  row.className = 'timeline-control-row';
  row.dataset.runbookId = runbook.id;

  // START column - editable until completed
  var startCell = document.createElement('div');
  startCell.className = 'timeline-control-cell';
  var startInput = document.createElement('input');
  startInput.type = 'text';
  startInput.pattern = '[0-9]{1,3}:[0-9]{2}';
  startInput.placeholder = 'HH:MM';
  startInput.value = String(runbook.scheduleHours).padStart(2,'0') + ':' + String(runbook.scheduleMinutes).padStart(2,'0');
  startInput.dataset.runbookId = runbook.id;
  startInput.dataset.fieldType = 'start';
  startInput.readOnly = runbook.completed;
  if (runbook.completed) startInput.style.background = '#f8fafb';
  
  startInput.onfocus = function() { 
    window.AppState.timelineInputLock = true;
    window.AppState.focusedTimelineInput = this;
  };
  startInput.onblur = function() { 
    setTimeout(function() {
      window.AppState.timelineInputLock = false;
      window.AppState.focusedTimelineInput = null;
    }, 300);
  };
  startInput.onchange = function() { updateScheduleTime(runbook.id, this.value); };
  startInput.oninput = startInput.onchange;
  startCell.appendChild(startInput);
  row.appendChild(startCell);

  // PLAN column - editable until completed
  var planCell = document.createElement('div');
  planCell.className = 'timeline-control-cell';
  var planInput = document.createElement('input');
  planInput.type = 'text';
  planInput.pattern = '[0-9]{1,3}:[0-9]{2}';
  planInput.placeholder = 'HH:MM';
  planInput.value = String(runbook.durationHours).padStart(2,'0') + ':' + String(runbook.durationMinutes).padStart(2,'0');
  planInput.dataset.runbookId = runbook.id;
  planInput.dataset.fieldType = 'plan';
  planInput.readOnly = runbook.completed;
  if (runbook.completed) planInput.style.background = '#f8fafb';
  
  planInput.onfocus = function() { 
    window.AppState.timelineInputLock = true;
    window.AppState.focusedTimelineInput = this;
  };
  planInput.onblur = function() { 
    setTimeout(function() {
      window.AppState.timelineInputLock = false;
      window.AppState.focusedTimelineInput = null;
    }, 300);
  };
  planInput.onchange = function() { updateDurationTime(runbook.id, this.value); };
  planInput.oninput = planInput.onchange;
  planCell.appendChild(planInput);
  row.appendChild(planCell);

  // END column - only enabled when downtime is started and not paused
  var endCell = document.createElement('div');
  endCell.className = 'timeline-control-cell';
  var checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.className = 'timeline-checkbox';
  checkbox.checked = runbook.completed;
  checkbox.title = 'Mark as completed';
  checkbox.disabled = !(window.AppState.downtimeStarted && !window.AppState.downtimePaused);
  checkbox.dataset.runbookId = runbook.id;
  checkbox.onchange = function() { toggleCompleted(runbook.id, this.checked); };
  endCell.appendChild(checkbox);
  row.appendChild(endCell);
  
  // ACTUAL column
  var actualCell = document.createElement('div');
  actualCell.className = 'timeline-control-cell';
  var actualSpan = document.createElement('span');
  actualSpan.style.fontSize = '11px';
  actualSpan.style.color = runbook.actualDuration ? '#107e3e' : '#999';
  actualSpan.textContent = runbook.actualDuration || '--:--';
  actualSpan.dataset.runbookId = runbook.id;
  actualCell.appendChild(actualSpan);
  row.appendChild(actualCell);
  
  return row;
}

// New function to update existing timeline control row without recreating inputs
function updateTimelineControlRow(row, runbook) {
  if (!row || !runbook) return;
  
  row.dataset.runbookId = runbook.id;
  
  var cells = row.querySelectorAll('.timeline-control-cell');
  if (cells.length < 4) return;
  
  // Update START input (only if not currently focused)
  var startInput = cells[0].querySelector('input[type="text"]');
  if (startInput && startInput !== window.AppState.focusedTimelineInput) {
    var newStartValue = String(runbook.scheduleHours).padStart(2,'0') + ':' + String(runbook.scheduleMinutes).padStart(2,'0');
    if (startInput.value !== newStartValue) {
      startInput.value = newStartValue;
    }
    startInput.readOnly = runbook.completed;
    startInput.style.background = runbook.completed ? '#f8fafb' : '#fff';
  }
  
  // Update PLAN input (only if not currently focused)
  var planInput = cells[1].querySelector('input[type="text"]');
  if (planInput && planInput !== window.AppState.focusedTimelineInput) {
    var newPlanValue = String(runbook.durationHours).padStart(2,'0') + ':' + String(runbook.durationMinutes).padStart(2,'0');
    if (planInput.value !== newPlanValue) {
      planInput.value = newPlanValue;
    }
    planInput.readOnly = runbook.completed;
    planInput.style.background = runbook.completed ? '#f8fafb' : '#fff';
  }
  
  // Update END checkbox
  var checkbox = cells[2].querySelector('input[type="checkbox"]');
  if (checkbox) {
    checkbox.checked = runbook.completed;
    checkbox.disabled = !(window.AppState.downtimeStarted && !window.AppState.downtimePaused);
  }
  
  // Update ACTUAL display
  var actualSpan = cells[3].querySelector('span');
  if (actualSpan) {
    actualSpan.textContent = runbook.actualDuration || '--:--';
    actualSpan.style.color = runbook.actualDuration ? '#107e3e' : '#999';
  }
}

function createTimelineBlock(runbook) {
  var block = document.createElement('div');
  var strategyClass = runbook.strategy.toLowerCase().replace(/\s+/g, '');
  block.className = 'timeline-block block-' + strategyClass;
  block.dataset.runbookId = runbook.id;
  
  // Add status-specific styling
  var status = runbook.status || 'not-started';
  if (status === 'blocked') {
    block.style.border = '2px solid #f44336';
    block.style.filter = 'brightness(0.8)';
  } else if (status === 'in-progress') {
    block.style.boxShadow = '0 0 8px rgba(33, 150, 243, 0.8)';
  } else if (status === 'skipped') {
    block.style.opacity = '0.5';
    block.style.textDecoration = 'line-through';
  } else if (status === 'in-error') {
    block.style.border = '2px solid #d32f2f';
    block.style.boxShadow = '0 0 8px rgba(211, 47, 47, 0.8)';
  }
  
  if (runbook.critical) {
    block.classList.add('critical');
  }
  
  if (runbook.completed || status === 'completed') {
    block.classList.add('completed');
    block.draggable = false;
  } else {
    block.draggable = true;
  }
  
  var pixelsPerHour = 60;
  
  // Calculate position considering predecessors
  var blockPositions = calculateBlockPositions();
  var pos = blockPositions[runbook.id];
  var position = pos ? pos.start : (runbook.scheduleHours + (runbook.scheduleMinutes / 60));
  var duration = runbook.durationHours + (runbook.durationMinutes / 60);
  
  block.style.left = (position * pixelsPerHour) + 'px';
  block.style.width = Math.max(60, duration * pixelsPerHour - 4) + 'px';
  
  // Show sequence and phase inside with predecessor indicator
  var labelText = '#' + runbook.sequence;
  if (runbook.predecessor) {
    labelText += ' (‚Üí' + runbook.predecessor + ')';
  }
  labelText += ' | ' + runbook.phase;
  block.textContent = labelText;
  block.title = runbook.runblock + ' - ' + runbook.phase + ' [' + status + ']';
  
  // Add external label for runblock name
  var blockLabel = document.createElement('div');
  blockLabel.className = 'block-label-external';
  blockLabel.textContent = runbook.runblock;
  block.appendChild(blockLabel);
  
  if (runbook.critical) {
    var indicator = document.createElement('div');
    indicator.className = 'critical-indicator';
    indicator.textContent = '!';
    indicator.title = 'Critical Path Item';
    block.appendChild(indicator);
  }
  
  // Add tooltip events
  block.addEventListener('mouseenter', function(e) {
    showEnhancedTooltip(runbook, e);
  });
  block.addEventListener('mousemove', function(e) {
    var tooltip = document.getElementById('enhancedTooltip');
    if (tooltip && tooltip.classList.contains('show')) {
      tooltip.style.left = (e.clientX + 20) + 'px';
      tooltip.style.top = (e.clientY + 20) + 'px';
    }
  });
  block.addEventListener('mouseleave', hideEnhancedTooltip);
  
  if (!runbook.completed && status !== 'completed') {
    block.addEventListener('dragstart', handleDragStart);
    block.addEventListener('dragend', handleDragEnd);
  }
  
  return block;
}

// Drag and Drop Handlers
function handleDragStart(e) {
  e.dataTransfer.effectAllowed = 'move';
  e.target.classList.add('dragging');
  window.AppState.currentDraggedBlock = e.target;
  
  var rect = e.target.getBoundingClientRect();
  window.AppState.dragOffset = e.clientX - rect.left;
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  window.AppState.currentDraggedBlock = null;
  window.AppState.dragOffset = 0;
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  
  if (window.AppState.currentDraggedBlock && e.currentTarget.classList.contains('timeline-track')) {
    var track = e.currentTarget;
    var rect = track.getBoundingClientRect();
    var x = e.clientX - rect.left - (window.AppState.dragOffset || 0);
    var pixelsPerHour = 60;
    
    var position = Math.max(0, x / pixelsPerHour);
    var runbookId = parseFloat(window.AppState.currentDraggedBlock.dataset.runbookId);
    var runbook = window.AppState.runbooks.find(function(r) { return r.id === runbookId; });
    
    if (runbook) {
      var duration = runbook.durationHours + (runbook.durationMinutes / 60);
      var maxPosition = window.AppState.downtimeDuration - duration;
      var validPosition = Math.min(position, maxPosition);
      
      window.AppState.currentDraggedBlock.style.left = (validPosition * pixelsPerHour) + 'px';
    }
  }
}

function handleDrop(e) {
  e.preventDefault();
  
  if (!window.AppState.currentDraggedBlock) return;
  
  var track = e.currentTarget;
  var rect = track.getBoundingClientRect();
  var x = e.clientX - rect.left - (window.AppState.dragOffset || 0);
  var pixelsPerHour = 60;
  var newPosition = Math.max(0, x / pixelsPerHour);
  
  var runbookId = parseFloat(window.AppState.currentDraggedBlock.dataset.runbookId);
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === runbookId; });
  
  if (runbook) {
    var duration = runbook.durationHours + (runbook.durationMinutes / 60);
    var maxPosition = window.AppState.downtimeDuration - duration;
    var finalPosition = Math.min(newPosition, maxPosition);
    var snappedPosition = Math.round(finalPosition * 12) / 12;
    
    var newHours = Math.floor(snappedPosition);
    var newMinutes = Math.round((snappedPosition % 1) * 60);
    
    runbook.scheduleHours = newHours;
    runbook.scheduleMinutes = newMinutes;
    
    updateTimeline();
  }
}

// Debounced update functions for better performance
var scheduleTimeUpdateDebounce = {};
var durationTimeUpdateDebounce = {};

window.updateScheduleTime = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    var t = parseHHMM(value);
    runbook.scheduleHours = t.h;
    runbook.scheduleMinutes = t.m;
    
    // Clear existing timeout for this runbook
    if (scheduleTimeUpdateDebounce[id]) {
      clearTimeout(scheduleTimeUpdateDebounce[id]);
    }
    
    // Debounce the timeline update
    scheduleTimeUpdateDebounce[id] = setTimeout(function() {
      try {
        var controls = document.getElementById('timelineControlsRows');
        var sorted = window.AppState.runbooks.slice().sort(function(a,b) { return a.sequence - b.sequence; });
        var idx = sorted.findIndex(function(r) { return r.id === id; });
        if (controls && idx > -1 && controls.children[idx]) {
          var inp = controls.children[idx].querySelectorAll('.timeline-control-cell input[type="text"]')[0];
          if (inp && inp !== window.AppState.focusedTimelineInput) {
            inp.value = formatHHMM(t.h, t.m);
          }
        }
      } catch(e) {
        console.error('Error updating schedule time display:', e);
      }
      updateSingleBlockPosition(id);
      scheduleConflicts();
      scheduleValidation();
      delete scheduleTimeUpdateDebounce[id];
    }, 300);
  }
};

window.updateDurationTime = function(id, value) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    var t = parseHHMM(value);
    runbook.durationHours = t.h;
    runbook.durationMinutes = t.m;
    
    // Clear existing timeout for this runbook
    if (durationTimeUpdateDebounce[id]) {
      clearTimeout(durationTimeUpdateDebounce[id]);
    }
    
    // Debounce the timeline update
    durationTimeUpdateDebounce[id] = setTimeout(function() {
      try {
        var controls = document.getElementById('timelineControlsRows');
        var sorted = window.AppState.runbooks.slice().sort(function(a,b) { return a.sequence - b.sequence; });
        var idx = sorted.findIndex(function(r) { return r.id === id; });
        if (controls && idx > -1 && controls.children[idx]) {
          var inp = controls.children[idx].querySelectorAll('.timeline-control-cell input[type="text"]')[1];
          if (inp && inp !== window.AppState.focusedTimelineInput) {
            inp.value = formatHHMM(t.h, t.m);
          }
        }
      } catch(e) {
        console.error('Error updating duration time display:', e);
      }
      updateSingleBlockWidth(id);
      scheduleConflicts();
      scheduleValidation();
      delete durationTimeUpdateDebounce[id];
    }, 300);
  }
};

window.toggleCompleted = function(id, checked) {
  var runbook = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (runbook) {
    runbook.completed = checked;
    
    if (checked && window.AppState.downtimeStartTime) {
      var now = new Date();
      var startTime = new Date(window.AppState.downtimeStartTime);
      var scheduledOffset = runbook.scheduleHours * 3600000 + runbook.scheduleMinutes * 60000;
      var taskStart = new Date(startTime.getTime() + scheduledOffset);
      
      var actualMs = now - taskStart - window.AppState.pausedDuration;
      var actualHours = Math.floor(actualMs / 3600000);
      var actualMinutes = Math.floor((actualMs % 3600000) / 60000);
      
      // Store the actual duration permanently
      runbook.actualDuration = String(Math.max(0, actualHours)).padStart(2,'0') + ':' + String(Math.max(0, actualMinutes)).padStart(2,'0');
      window.AppState.completionTimes[id] = now.toISOString();
      
      // Force immediate update to timeline to show actual duration
      setTimeout(function() {
        var controls = document.getElementById('timelineControlsRows');
        var sorted = window.AppState.runbooks.slice().sort(function(a,b) { return a.sequence - b.sequence; });
        var idx = sorted.findIndex(function(r) { return r.id === id; });
        if (controls && idx > -1 && controls.children[idx]) {
          var actualCell = controls.children[idx].querySelectorAll('.timeline-control-cell')[3];
          if (actualCell) {
            var actualSpan = actualCell.querySelector('span');
            if (actualSpan) {
              actualSpan.textContent = runbook.actualDuration;
              actualSpan.style.color = '#107e3e';
            }
          }
        }
      }, 50);
    } else if (!checked) {
      runbook.actualDuration = null;
      delete window.AppState.completionTimes[id];
    }
    
    // Update completion percentage
    updateCompletionPercentage();
    
    // Delay the timeline update to prevent interference with checkbox
    setTimeout(function() {
      updateTimeline();
    }, 100);
  }
};

// Downtime Control Functions
window.startDowntime = function() {
  // Check if user can actually control (is host)
  if (!window.canWrite()) {
    alert("‚ö†Ô∏è You are in VIEWER mode and cannot start downtime.\n\nOnly the HOST can control the session.");
    return;
  }
  
  // Always use current system time when starting
  window.AppState.downtimeStartTime = new Date();
  
  window.AppState.downtimeStarted = true;
  window.AppState.downtimePaused = false;
  window.AppState.pausedDuration = 0;
  window.AppState.pauseStartTime = null;
  
  var downtimeDuration = parseInt(document.getElementById('downtimeDuration').value) || 24;
  window.AppState.downtimeDuration = downtimeDuration;
  
  // Lock customer name and transform cycle inputs
  var customerNameInput = document.getElementById('customerName');
  var transformCycleInput = document.getElementById('transformCycle');
  if (customerNameInput) customerNameInput.disabled = true;
  if (transformCycleInput) transformCycleInput.disabled = true;
  
  console.log("‚úì Downtime started by host:", uid);
  
  // Update UI
  document.getElementById('startTimeInput').style.display = 'none';
  document.getElementById('startTimeDisplay').style.display = 'block';
  document.getElementById('currentDurationInput').style.display = 'none';
  document.getElementById('currentDurationDisplay').style.display = 'block';
  
  var startTimeStr = window.AppState.downtimeStartTime.toLocaleTimeString('en-US', 
    { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
  
  document.getElementById('startTimeDisplay').textContent = startTimeStr;
  
  // Set current duration to 00:00:00
  document.getElementById('currentDurationDisplay').textContent = '00:00:00';
  
  calculateEndTime();
  
  document.getElementById('statusText').textContent = 'In Progress';
  document.getElementById('statusText').style.color = 'var(--sap-error)';
  
  document.getElementById('downtimeControls').innerHTML = 
    '<button class="btn warning" onclick="pauseDowntime()">‚è∏ Pause</button>' +
    '<button class="btn danger" onclick="stopDowntime()">‚èπ Stop</button>';
  
  var currentLine = document.getElementById('currentTimeLine');
  if (currentLine) {
    currentLine.style.display = 'block';
    currentLine.style.left = '0px';
  }
  
  updateProgressIndicators();
  updateTimeline();
  renderRunbookTable();
};

window.pauseDowntime = function() {
  if (!window.AppState.downtimePaused) {
    window.AppState.downtimePaused = true;
    window.AppState.pauseStartTime = new Date();
    document.getElementById('statusText').textContent = 'Paused';
    document.getElementById('statusText').style.color = 'var(--sap-warning)';
    
    document.getElementById('downtimeControls').innerHTML = 
      '<button class="btn primary" onclick="resumeDowntime()">‚ñ∂ Resume</button>' +
      '<button class="btn danger" onclick="stopDowntime()">‚èπ Stop</button>';

    updateTimeline();
    renderRunbookTable();
  }
};

window.resumeDowntime = function() {
  if (window.AppState.downtimePaused) {
    var pauseDuration = new Date() - window.AppState.pauseStartTime;
    window.AppState.pausedDuration += pauseDuration;
    window.AppState.downtimePaused = false;
    window.AppState.pauseStartTime = null;
    
    document.getElementById('statusText').textContent = 'In Progress';
    document.getElementById('statusText').style.color = 'var(--sap-error)';
    
    document.getElementById('downtimeControls').innerHTML = 
      '<button class="btn warning" onclick="pauseDowntime()">‚è∏ Pause</button>' +
      '<button class="btn danger" onclick="stopDowntime()">‚èπ Stop</button>';
    
    var currentLine = document.getElementById('currentTimeLine');
    if (currentLine) currentLine.style.display = 'block';

    updateTimeline();
    renderRunbookTable();
  }
};

window.stopDowntime = function() {
  if (confirm('Are you sure you want to stop the downtime tracking? All times will be reset.')) {
    window.AppState.downtimeStarted = false;
    window.AppState.downtimeStartTime = null;
    window.AppState.downtimePaused = false;
    window.AppState.pausedDuration = 0;
    window.AppState.pauseStartTime = null;
    
    // Reset actual durations
    window.AppState.runbooks.forEach(function(r) {
      r.actualDuration = null;
      r.completed = false;
    });
    window.AppState.completionTimes = {};
    
    // Unlock customer name and transform cycle inputs
    var customerNameInput = document.getElementById('customerName');
    var transformCycleInput = document.getElementById('transformCycle');
    if (customerNameInput) customerNameInput.disabled = false;
    if (transformCycleInput) transformCycleInput.disabled = false;
    
    setupStartTimeInputs();
    
    document.getElementById('startTimeDisplay').textContent = '--:--:--';
    document.getElementById('endTimeDisplay').textContent = '--:--:--';
    document.getElementById('currentDurationDisplay').textContent = '00:00:00';
    document.getElementById('statusText').textContent = 'Not Started';
    document.getElementById('statusText').style.color = 'var(--sap-warning)';
    
    document.getElementById('downtimeControls').innerHTML = 
      '<button class="btn primary" id="startDowntimeBtn" onclick="startDowntime()">Start Downtime</button>';
    
    var currentLine = document.getElementById('currentTimeLine');
    if (currentLine) currentLine.style.display = 'none';
    
    updateTimeline();
    renderRunbookTable();
    updateCompletionPercentage();
  }
};

window.updateProgressIndicators = function() {
  if (!window.AppState.downtimeStarted || !window.AppState.downtimeStartTime) return;
  
  var now = new Date();
  var elapsedMs = now - window.AppState.downtimeStartTime - window.AppState.pausedDuration;
  var elapsed = elapsedMs / 3600000;
  
  var pixelsPerHour = 60;
  var linePosition = Math.min(elapsed * pixelsPerHour, window.AppState.downtimeDuration * pixelsPerHour);
  
  // Store position for viewer sync
  window.AppState.syncedTimelinePosition = linePosition;
  
  var currentLine = document.getElementById('currentTimeLine');
  if (currentLine) {
    currentLine.style.left = linePosition + 'px';
    currentLine.style.display = 'block';
    
    var totalSeconds = Math.floor(elapsedMs / 1000);
    var hours = Math.floor(totalSeconds / 3600);
    var minutes = Math.floor((totalSeconds % 3600) / 60);
    var seconds = totalSeconds % 60;
    
    var timeStr = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    var label = document.getElementById('currentTimeLabel');
    if (label) label.textContent = timeStr;
  }
    
  if (elapsed >= window.AppState.downtimeDuration) {
    document.getElementById('statusText').textContent = 'Completed';
    document.getElementById('statusText').style.color = 'var(--sap-accent)';
  }
};

// Import/Export Functions
window.downloadExcel = function() {
  var data = window.AppState.runbooks.map(function(r) {
    return {
      Sequence: r.sequence,
      Strategy: r.strategy,
      Phase: r.phase,
      Runblock: r.runblock || '',
      Responsibility: r.responsibility || '',
      Status: r.status || 'not-started',
      Critical: r.critical ? 'Yes' : 'No',
      ScheduleTime: String(r.scheduleHours).padStart(2,'0') + ':' + String(r.scheduleMinutes).padStart(2,'0'),
      PlannedDuration: String(r.durationHours).padStart(2,'0') + ':' + String(r.durationMinutes).padStart(2,'0'),
      ActualDuration: r.actualDuration || '',
      Completed: r.completed ? 'Yes' : 'No'
    };
  });
  
  var headers = ['Sequence','Strategy','Phase','Runblock','Responsibility','Status','Critical','ScheduleTime','PlannedDuration','ActualDuration','Completed'];
  var csvContent = [
    headers.join(',')
  ].concat(data.map(function(row) {
    return headers.map(function(header) {
      return '"' + (row[header] || '') + '"';
    }).join(',');
  })).join('\n');
  
  var customerName = document.getElementById('customerName').value || 'customer';
  var safeCustomerName = customerName.replace(/[^a-zA-Z0-9]/g, '_');
  var dateStr = new Date().toISOString().slice(0,10);
  
  var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = safeCustomerName + '_downtime_runbook_' + dateStr + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

window.uploadExcel = function(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var text = e.target.result;
      var lines = text.split('\n');
      var headers = lines[0].split(',').map(function(h) { return h.replace(/"/g, '').trim(); });
      
      window.AppState.runbooks = [];
      
      for (var i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          var matches = lines[i].match(/(".*?"|[^,]+)/g);
          var values = matches ? matches.map(function(v) { return v.replace(/"/g, '').trim(); }) : [];
          
          var scheduleTime = values[headers.indexOf('ScheduleTime')] || '00:00';
          var scheduleTimeParts = scheduleTime.split(':').map(Number);
          var scheduleHours = scheduleTimeParts[0] || 0;
          var scheduleMinutes = scheduleTimeParts[1] || 0;
          
          var planDuration = values[headers.indexOf('PlannedDuration')] || values[headers.indexOf('Duration')] || '01:00';
          var planDurationParts = planDuration.split(':').map(Number);
          var durationHours = planDurationParts[0] || 1;
          var durationMinutes = planDurationParts[1] || 0;
          
          var status = values[headers.indexOf('Status')] || 'not-started';
          if (TASK_STATUSES.indexOf(status) === -1) {
            status = 'not-started';
          }
          
          var runbook = {
            id: Date.now() + Math.random() + i,
            sequence: parseInt(values[headers.indexOf('Sequence')]) || i,
            strategy: values[headers.indexOf('Strategy')] || STRATEGIES[0],
            phase: values[headers.indexOf('Phase')] || PHASES[0],
            runblock: values[headers.indexOf('Runblock')] || '',
            responsibility: values[headers.indexOf('Responsibility')] || '',
            status: status,
            critical: values[headers.indexOf('Critical')] === 'Yes',
            scheduleHours: scheduleHours,
            scheduleMinutes: scheduleMinutes,
            durationHours: durationHours,
            durationMinutes: durationMinutes,
            actualDuration: values[headers.indexOf('ActualDuration')] || null,
            completed: values[headers.indexOf('Completed')] === 'Yes',
            position: 0
          };
          
          window.AppState.runbooks.push(runbook);
        }
      }
      
      renderRunbookTable();
      updateTimeline();
      updateCompletionPercentage();
      alert('Configuration loaded successfully!');
      
    } catch (error) {
      alert('Error loading file. Please check the format.');
      console.error('Upload error:', error);
    }
  };
  reader.readAsText(file);
  
  event.target.value = '';
};

// PDF Report Generation
window.generatePDFReport = async function() {
  if (typeof window.jspdf === 'undefined') {
    alert('PDF library not loaded. Please refresh the page and try again.');
    return;
  }
  
  var jsPDF = window.jspdf.jsPDF;
  var pdf = new jsPDF('l', 'mm', 'a4');
  
  var customerName = document.getElementById('customerName').value || 'Unknown Customer';
  var transformCycle = document.getElementById('transformCycle').value || 'Unknown Phase';
  var currentDate = new Date().toLocaleString();
  
  pdf.setFontSize(20);
  pdf.text('Technical Downtime Report', 20, 20);
  
  pdf.setFontSize(12);
  pdf.text('Customer: ' + customerName, 20, 30);
  pdf.text('Transform Cycle: ' + transformCycle, 20, 37);
  pdf.text('Generated: ' + currentDate, 20, 44);
  
  pdf.setFontSize(14);
  pdf.text('Execution Status', 20, 55);
  
  pdf.setFontSize(10);
  var statusText = document.getElementById('statusText').textContent;
  var startTime = document.getElementById('startTimeDisplay').textContent;
  var endTime = document.getElementById('endTimeDisplay').textContent;
  var duration = document.getElementById('currentDurationDisplay').textContent;
  
  pdf.text('Status: ' + statusText, 20, 62);
  pdf.text('Start Time: ' + startTime, 20, 68);
  pdf.text('End Time: ' + endTime, 20, 74);
  pdf.text('Current Duration: ' + duration, 20, 80);
  
  // Capture timeline
  var timelineContainer = document.querySelector('.timeline-container');
  if (timelineContainer && typeof html2canvas !== 'undefined') {
    try {
      var canvas = await html2canvas(timelineContainer, {
        scale: 2,
        logging: false,
        useCORS: true
      });
      
      var imgData = canvas.toDataURL('image/png');
      pdf.text('Timeline View', 20, 92);
      var imgWidth = 250;
      var imgHeight = (canvas.height * imgWidth) / canvas.width;
      pdf.addImage(imgData, 'PNG', 20, 97, imgWidth, Math.min(imgHeight, 80));
    } catch (error) {
      console.error('Error capturing timeline:', error);
    }
  }
  
  // Add runbook details
  pdf.addPage();
  pdf.setFontSize(14);
  pdf.text('Runbook Details', 20, 20);
  
  pdf.setFontSize(9);
  var yPos = 30;
  var headers = ['Seq', 'Strategy', 'Phase', 'Runblock', 'Critical', 'Start', 'Plan', 'Actual', 'Complete'];
  var xPositions = [20, 30, 55, 80, 120, 140, 160, 180, 200];
  
  headers.forEach(function(header, i) {
    pdf.text(header, xPositions[i], yPos);
  });
  
  yPos += 7;
  window.AppState.runbooks.forEach(function(runbook) {
    if (yPos > 180) {
      pdf.addPage();
      yPos = 20;
      headers.forEach(function(header, i) {
        pdf.text(header, xPositions[i], yPos);
      });
      yPos += 7;
    }
    
    var rowData = [
      runbook.sequence.toString(),
      runbook.strategy.substring(0, 12),
      runbook.phase.substring(0, 10),
      runbook.runblock.substring(0, 25),
      runbook.critical ? 'Yes' : 'No',
      String(runbook.scheduleHours).padStart(2,'0') + ':' + String(runbook.scheduleMinutes).padStart(2,'0'),
      String(runbook.durationHours).padStart(2,'0') + ':' + String(runbook.durationMinutes).padStart(2,'0'),
      runbook.actualDuration || '--:--',
      runbook.completed ? 'Yes' : 'No'
    ];
    
    rowData.forEach(function(data, i) {
      pdf.text(data, xPositions[i], yPos);
    });
    
    yPos += 6;
  });
  
  // Summary
  var totalTasks = window.AppState.runbooks.length;
  var completedTasks = window.AppState.runbooks.filter(function(r) { return r.completed; }).length;
  var criticalTasks = window.AppState.runbooks.filter(function(r) { return r.critical; }).length;
  var completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
  
  pdf.addPage();
  pdf.setFontSize(14);
  pdf.text('Summary Statistics', 20, 20);
  
  pdf.setFontSize(10);
  pdf.text('Total Tasks: ' + totalTasks, 20, 30);
  pdf.text('Completed Tasks: ' + completedTasks, 20, 36);
  pdf.text('Critical Path Items: ' + criticalTasks, 20, 42);
  pdf.text('Completion Rate: ' + completionRate + '%', 20, 48);
  
  var safeCustomerName = customerName.replace(/[^a-zA-Z0-9]/g, '_');
  var dateStr = new Date().toISOString().slice(0,10);
  pdf.save(safeCustomerName + '_downtime_report_' + dateStr + '.pdf');
};

// Dropdown focus management - prevent premature closing
document.addEventListener('mousedown', function(e) {
  if (e.target.tagName === 'SELECT' || e.target.closest('select')) {
    e.target.__dropdownFocus = true;
    setTimeout(function() {
      delete e.target.__dropdownFocus;
    }, 300);
  }
}, true);

document.addEventListener('blur', function(e) {
  if (e.target.tagName === 'SELECT' && e.target.__dropdownFocus) {
    e.preventDefault();
    e.stopPropagation();
    e.target.focus();
  }
}, true);

// Time parsing and formatting functions
function parseHHMM(str) {
  if (!str) return {h:0, m:0, ok:false};
  str = String(str).trim();
  var h = 0, m = 0, ok = false;
  if (/^\d{1,3}:\d{1,2}$/.test(str)) {
    var parts = str.split(':');
    h = parseInt(parts[0], 10) || 0;
    m = parseInt(parts[1], 10) || 0;
    ok = true;
  } else if (/^\d{3,}$/.test(str)) {
    var mm = str.slice(-2);
    var hh = str.slice(0, -2);
    h = parseInt(hh, 10) || 0;
    m = parseInt(mm, 10) || 0;
    ok = true;
  }
  if (m >= 60) { 
    h += Math.floor(m / 60); 
    m = m % 60; 
  }
  if (m < 0) m = 0;
  if (h < 0) h = 0;
  return {h: h, m: m, ok: ok};
}

function formatHHMM(h, m) {
  h = Math.max(0, parseInt(h || 0, 10));
  m = Math.max(0, parseInt(m || 0, 10)) % 60;
  return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
}

// Debounce helper
function debounce(fn, delay) { 
  var t; 
  return function() { 
    var ctx = this, args = arguments; 
    clearTimeout(t); 
    t = setTimeout(function() {
      fn.apply(ctx, args);
    }, delay); 
  }; 
}

// Enhancements
function attachTimeInputEnhancements(input, type, id) {
  if (!input) return;
  input.setAttribute('inputmode', 'numeric');
  input.setAttribute('title', 'Use HH:MM (e.g., 01:30). Arrow Up/Down ¬±1 min, Shift+Arrow ¬±5 min.');

  var validate = function() {
    var val = input.value.trim();
    var match = /^\d{1,3}:\d{1,2}$/.test(val) || /^\d{3,}$/.test(val);
    if (!match) { 
      input.classList.add('input-invalid'); 
    } else { 
      input.classList.remove('input-invalid'); 
    }
  };
  input.addEventListener('input', validate);
  input.addEventListener('blur', function() { 
    input.classList.remove('input-invalid'); 
  });

  input.addEventListener('keydown', function(e) {
    if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
    e.preventDefault();
    var delta = (e.shiftKey ? 5 : 1) * (e.key === 'ArrowUp' ? 1 : -1);
    var t = parseHHMM(input.value);
    var total = t.h * 60 + t.m + delta;
    if (total < 0) total = 0;
    var nh = Math.floor(total / 60);
    var nm = total % 60;
    var nv = formatHHMM(nh, nm);
    input.value = nv;
    if (type === 'start') window.updateScheduleTime(id, nv);
    else window.updateDurationTime(id, nv);
  });
}

function updateSingleBlockPosition(id) {
  var rb = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (!rb) return;
  var pph = 60;
  var pos = rb.scheduleHours + rb.scheduleMinutes / 60;
  var x = pos * pph;

  var block = document.querySelector('.timeline-block[data-runbook-id="' + id + '"]');
  var diamond = document.querySelector('.quality-diamond[data-runbook-id="' + id + '"]');
  if (block) block.style.left = x + 'px';
  if (diamond) diamond.style.left = Math.max(0, x - 7) + 'px';
}

function updateSingleBlockWidth(id) {
  var rb = window.AppState.runbooks.find(function(r) { return r.id === id; });
  if (!rb) return;
  var pph = 60;
  var dur = rb.durationHours + rb.durationMinutes / 60;
  var w = Math.max(60, dur * pph - 4);
  var block = document.querySelector('.timeline-block[data-runbook-id="' + id + '"]');
  if (block) block.style.width = w + 'px';
}

var scheduleConflicts = debounce(recomputeConflicts, 120);
var scheduleValidation = debounce(displayValidationWarnings, 150);

function clearConflictArtifacts() {
  document.querySelectorAll('.conflict-overlay').forEach(function(el) { el.remove(); });
  document.querySelectorAll('.timeline-block .conflict-indicator').forEach(function(el) { el.remove(); });
  document.querySelectorAll('.timeline-block .slack-badge').forEach(function(el) { el.remove(); });
  document.querySelectorAll('.timeline-block .quick-fix').forEach(function(el) { el.remove(); });
}

function recomputeConflicts() {
  clearConflictArtifacts();
  var pph = 60;
  var runbooks = window.AppState.runbooks
    .filter(function(r) { return r && r.runblock && r.runblock.trim().length > 0; })
    .sort(function(a, b) { return a.sequence - b.sequence; });

  // Slack badges
  for (var i = 0; i < runbooks.length; i++) {
    var a = runbooks[i];
    var aStart = a.scheduleHours + a.scheduleMinutes / 60;
    var aEnd = aStart + a.durationHours + a.durationMinutes / 60;
    var next = runbooks[i + 1];
    if (next) {
      var nStart = next.scheduleHours + next.scheduleMinutes / 60;
      var slack = Math.max(0, nStart - aEnd);
      var block = document.querySelector('.timeline-block[data-runbook-id="' + a.id + '"]');
      if (block && slack > 0) {
        var badge = document.createElement('span');
        badge.className = 'slack-badge';
        var min = Math.round(slack * 60);
        badge.textContent = 'Slack ' + (min >= 60 ? Math.floor(min / 60) + 'h ' + (min % 60) + 'm' : min + 'm');
        block.appendChild(badge);
      }
    }
  }

  // Conflicts & overlays
  for (var i = 0; i < runbooks.length; i++) {
    for (var j = i + 1; j < runbooks.length; j++) {
      var a = runbooks[i], b = runbooks[j];
      var aStart = a.scheduleHours + a.scheduleMinutes / 60;
      var aEnd = aStart + a.durationHours + a.durationMinutes / 60;
      var bStart = b.scheduleHours + b.scheduleMinutes / 60;
      var bEnd = bStart + b.durationHours + b.durationMinutes / 60;
      if (aEnd > bStart && bEnd > aStart) {
        var later = (bStart >= aStart) ? b : a;
        var block = document.querySelector('.timeline-block[data-runbook-id="' + later.id + '"]');
        if (block) {
          var badge = document.createElement('span');
          badge.className = 'conflict-indicator';
          badge.textContent = 'CLASH';
          block.appendChild(badge);

          var fix = document.createElement('button');
          fix.className = 'quick-fix';
          fix.textContent = '+15m ‚Üí';
          fix.title = 'Shift next item by +15 minutes';
          fix.addEventListener('click', function(ev) {
            ev.stopPropagation();
            shiftFollowing(later.id, 15);
          });
          block.appendChild(fix);
        }
        var scroll = document.querySelector('.timeline-scroll');
        if (scroll) {
          var overlay = document.createElement('div');
          overlay.className = 'conflict-overlay';
          var left = Math.max(aStart, bStart) * pph;
          var right = Math.min(aEnd, bEnd) * pph;
          overlay.style.left = left + 'px';
          overlay.style.width = Math.max(2, right - left) + 'px';
          scroll.appendChild(overlay);
        }
      }
    }
  }
}

function shiftFollowing(id, minutes) {
  var runbooks = window.AppState.runbooks.slice().sort(function(a, b) { return a.sequence - b.sequence; });
  var idx = runbooks.findIndex(function(r) { return r.id === id; });
  var target = runbooks[idx + 1];
  if (!target) return;
  var total = target.scheduleHours * 60 + target.scheduleMinutes + minutes;
  if (total < 0) total = 0;
  target.scheduleHours = Math.floor(total / 60);
  target.scheduleMinutes = total % 60;
  window.updateScheduleTime(target.id, formatHHMM(target.scheduleHours, target.scheduleMinutes));
  updateSingleBlockPosition(target.id);
  scheduleConflicts();
}

// Override generateTimelineRows to add enhancements
var _origGenerateTimelineRows = generateTimelineRows;
generateTimelineRows = function() {
  // Don't regenerate if user is editing timeline inputs
  if (window.AppState.timelineInputLock) {
    return;
  }
  
  _origGenerateTimelineRows.apply(this, arguments);
  recomputeConflicts();
  
  var controls = document.getElementById('timelineControlsRows');
  if (controls) {
    var rows = controls.querySelectorAll('.timeline-control-row');
    var sorted = getFilteredRunbooks()
      .filter(function(r) { return r && r.runbook && r.runblock.trim().length > 0; })
      .sort(function(a, b) { return a.sequence - b.sequence; });
    rows.forEach(function(row, i) {
      var rb = sorted[i];
      if (!rb) return;
      var inputs = row.querySelectorAll('input[type="text"]');
      if (inputs[0]) attachTimeInputEnhancements(inputs[0], 'start', rb.id);
      if (inputs[1]) attachTimeInputEnhancements(inputs[1], 'plan', rb.id);
    });
  }
};

</script>

<!-- Firebase realtime sync -->
<script type="module">
// CRITICAL FIX: Initialize canWrite immediately to prevent errors
window.canWrite = function() {
  // Safe default: return true until Firebase sync is ready
  // This will be properly overridden once Firebase initializes
  return true;
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, collection, addDoc, deleteDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAredpIvTx0c7uxn23HZoD3YkTgcG4cHbk",
  authDomain: "downtime-tracking-135f6.firebaseapp.com",
  projectId: "downtime-tracking-135f6",
  storageBucket: "downtime-tracking-135f6.firebaseapp.com",
  messagingSenderId: "422856401277",
  appId: "1:422856401277:web:7b10cb426abf816d74ec14",
  measurementId: "G-CJ2F30SYRY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Template Management Functions
window.saveTemplateToFirebase = async function(template) {
  const templatesRef = collection(db, "templates");
  await addDoc(templatesRef, template);
};

window.loadTemplateFromFirebase = async function(templateId) {
  const templateRef = doc(db, "templates", templateId);
  const templateSnap = await getDoc(templateRef);
  if (templateSnap.exists()) {
    return templateSnap.data();
  }
  throw new Error('Template not found');
};

window.deleteTemplateFromFirebase = async function(templateId) {
  const templateRef = doc(db, "templates", templateId);
  await deleteDoc(templateRef);
};

window.loadTemplatesFromFirebase = async function() {
  const templatesRef = collection(db, "templates");
  const q = query(templatesRef, orderBy("createdAt", "desc"));
  const querySnapshot = await getDocs(q);
  
  const templates = [];
  querySnapshot.forEach((doc) => {
    templates.push({
      id: doc.id,
      ...doc.data()
    });
  });
  
  return templates;
};

// Get URL parameters
const url = new URL(window.location.href);
let customerParam = url.searchParams.get("customer") || "default";
let phaseParam = url.searchParams.get("phase") || url.searchParams.get("transformCycle") || "";
let viewerParam = url.searchParams.get("viewer");

const nameInput = document.getElementById("customerName");
const phaseInput = document.getElementById("transformCycle");

// Set initial values
if (customerParam && nameInput) nameInput.value = customerParam;
if (phaseParam && phaseInput) phaseInput.value = phaseParam;

// Generate safe key for Firebase
const toKey = s => (s||"default").toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"") || "default";
const customerKey = toKey(customerParam);

console.log("Session initialization:", {
  customerParam: customerParam,
  customerKey: customerKey,
  domain: window.location.hostname,
  fullUrl: window.location.href
});

// Determine mode (host vs viewer)
let isFirstUser = false;
let viewerForced = false;

// Auto-detect first user
async function detectMode() {
  const sessionRef = doc(db, "sessions", customerKey);
  
  console.log("Detecting mode for customer:", customerParam, "key:", customerKey);
  console.log("Current domain:", window.location.hostname);
  console.log("Viewer param:", viewerParam);
  
  if (viewerParam === null || viewerParam === undefined) {
    try {
      const sessionSnap = await getDoc(sessionRef);
      console.log("Session exists:", sessionSnap.exists());
      if (sessionSnap.exists()) {
        console.log("Session data:", sessionSnap.data());
      }
      
      if (!sessionSnap.exists() || !sessionSnap.data()?.controllerUid) {
        isFirstUser = true;
        url.searchParams.set("viewer", "0");
        window.AppState.isFirstUser = true;
        console.log("Mode: HOST (first user)");
      } else {
        url.searchParams.set("viewer", "1");
        viewerForced = true;
        console.log("Mode: VIEWER (session exists)");
      }
      history.replaceState(null, "", url.toString());
    } catch (e) {
      console.error("Error checking session:", e);
    }
  } else {
    viewerForced = viewerParam === "1";
    console.log("Mode: " + (viewerForced ? "VIEWER" : "HOST") + " (explicit)");
  }
}

await detectMode();

// Create status overlay
(function createOverlay() {
  const statusPanel = document.createElement("div");
  statusPanel.style.cssText = "position:fixed;right:10px;bottom:10px;background:#fff;border:1px solid #dcdcdc;border-radius:8px;padding:10px 12px;font:12px system-ui,-apple-system,sans-serif;box-shadow:0 2px 6px rgba(0,0,0,.08);z-index:100000;min-width:280px";
  statusPanel.innerHTML = `
    <div style="display:flex;gap:6px;align-items:center;justify-content:space-between;margin-bottom:6px;">
      <div><strong>Customer:</strong> <span style="font-family:monospace">${customerParam}</span></div>
      <button id="rt-copy" style="padding:4px 8px;border:1px solid #ccc;border-radius:6px;cursor:pointer;background:#f9f9fb;">üìã Copy link</button>
    </div>
    <div style="display:flex;gap:6px;align-items:center;justify-content:space-between;">
      <span id="rt-online" style="display:inline-block;padding:2px 8px;border:1px solid #dcdcdc;border-radius:999px;">0 online</span>
      <span id="rt-mode" style="font-weight:600;color:#444">mode: ‚Äî</span>
    </div>
    <div id="rt-viewer-panel" style="display:none;margin-top:8px">
      <div style="font-size:12px;margin-bottom:2px"><b>Status:</b> <span id="rt-status">‚Äî</span></div>
      <div style="font-size:12px;margin-bottom:4px"><b>Start:</b> <span id="rt-start">‚Äî</span></div>
      <div style="font-size:12px;margin-bottom:6px"><b>ETA:</b> <span id="rt-eta">‚Äî</span></div>
      <div style="position:relative;height:10px;border:1px solid #dcdcdc;border-radius:999px;overflow:hidden;background:#f2f3f6">
        <div id="rt-bar" style="position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#4CAF50,#2196F3)"></div>
      </div>
      <div id="rt-bar-label" style="font-size:11px;margin-top:4px;text-align:right">0%</div>
    </div>`;
  document.body.appendChild(statusPanel);
  
  document.getElementById("rt-copy").onclick = async () => {
    const shareUrl = new URL(window.location.href);
    shareUrl.searchParams.set("viewer", "1");
    await navigator.clipboard.writeText(shareUrl.toString());
    const btn = document.getElementById("rt-copy");
    const prev = btn.textContent;
    btn.textContent = "‚úì Copied";
    setTimeout(() => btn.textContent = prev, 1500);
  };
  
  const resetBtn = document.createElement("div");
  resetBtn.style.cssText = "position:fixed;left:10px;bottom:10px;z-index:100001";
  resetBtn.innerHTML = `<button id="rt-reset" style="padding:10px 14px;border:none;border-radius:8px;cursor:pointer;background:#d32f2f;color:#fff;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.15)">üîÑ Reset</button>`;
  document.body.appendChild(resetBtn);
})();

// Authenticate
await signInAnonymously(auth);
const uid = await new Promise((resolve) => onAuthStateChanged(auth, (u) => { if(u) resolve(u.uid); }));

// Presence tracking
const presenceRef = doc(db, "sessions", customerKey, "presence", uid);

async function updatePresence() {
  try {
    await window.firestore.setDoc(presenceRef, {
      name: nameInput?.value || customerParam || "Guest",
      lastActive: window.firestore.serverTimestamp()
    }, { merge: true });
  } catch(e) {
    console.error("Presence update failed:", e);
  }
}

await updatePresence();
setInterval(updatePresence, 20000);

// Track online users
window.firestore.onSnapshot(collection(db, "sessions", customerKey, "presence"), (snap) => {
  const now = Date.now();
  let online = 0;
  snap.forEach(d => {
    const t = d.data().lastActive?.toMillis?.() || 0;
    if (now - t < 45000) online++;
  });
  const el = document.getElementById("rt-online");
  if (el) el.textContent = `${online} online`;
});

// Session management
const sessionRef = doc(db, "sessions", customerKey);
let remoteController = null;
let lastSentState = null;
let writing = false;

// Check if can write - PROPERLY OVERRIDE THE EARLY INIT
window.canWrite = function() {
  // If viewer mode is forced via URL parameter, always return false
  if (viewerForced) return false;
  
  // If no remote controller set, we can write (we are/can be the host)
  if (!remoteController) return true;
  
  // If we are the remote controller, we can write
  if (remoteController === uid) return true;
  
  // Otherwise, we're a viewer
  return false;
};

// Serialize state
function serialize() {
  const state = window.AppState;
  return {
    runbooks: (state.runbooks || []).map(r => ({...r})),
    downtimeStarted: !!state.downtimeStarted,
    downtimeStartTime: state.downtimeStartTime ? new Date(state.downtimeStartTime).toISOString() : null,
    downtimeDuration: state.downtimeDuration || 24,
    downtimePaused: !!state.downtimePaused,
    pausedDuration: state.pausedDuration || 0,
    completionTimes: state.completionTimes || {},
    customerName: nameInput?.value || "",
    transformCycle: phaseInput?.value || "",
    syncedTimelinePosition: state.syncedTimelinePosition || 0,
    fullscreenMode: state.fullscreenMode || false
  };
}

// Apply remote state
function applyRemoteState(remoteState) {
  if (!remoteState) return;
  
  const state = window.AppState;
  
  // Update runbooks - ensure they have status field
  state.runbooks = Array.isArray(remoteState.runbooks) ? remoteState.runbooks.map(function(r) {
    return {
      ...r,
      status: r.status || 'not-started'
    };
  }) : [];
  state.downtimeStarted = !!remoteState.downtimeStarted;
  state.downtimeDuration = remoteState.downtimeDuration || 24;
  state.downtimePaused = !!remoteState.downtimePaused;
  state.pausedDuration = remoteState.pausedDuration || 0;
  state.downtimeStartTime = remoteState.downtimeStartTime ? new Date(remoteState.downtimeStartTime) : null;
  state.completionTimes = remoteState.completionTimes || {};
  state.syncedTimelinePosition = remoteState.syncedTimelinePosition || 0;
  
  // Sync fullscreen mode for viewers
  if (!window.canWrite() && remoteState.fullscreenMode !== undefined && state.fullscreenMode !== remoteState.fullscreenMode) {
    state.fullscreenMode = remoteState.fullscreenMode;
    if (state.fullscreenMode) {
      document.body.classList.add('fullscreen-mode');
      window.updateFullscreenCustomerInfo();
    } else {
      document.body.classList.remove('fullscreen-mode');
    }
    window.updateFullscreenButton(state.fullscreenMode);
  }
  
  // Only update UI fields if not currently being edited
  if (!state.inputLock) {
    if (nameInput && remoteState.customerName) nameInput.value = remoteState.customerName;
    if (phaseInput && remoteState.transformCycle) phaseInput.value = remoteState.transformCycle;
  }
  
  // Lock/unlock customer name and transform cycle based on downtime status
  var customerNameInput = document.getElementById('customerName');
  var transformCycleInput = document.getElementById('transformCycle');
  if (customerNameInput) {
    customerNameInput.disabled = state.downtimeStarted;
  }
  if (transformCycleInput) {
    transformCycleInput.disabled = state.downtimeStarted;
  }
  
  const durationInput = document.getElementById('downtimeDuration');
  if (durationInput) durationInput.value = state.downtimeDuration;
  
  // Update displays for running downtime
  if (state.downtimeStarted && state.downtimeStartTime) {
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const startTimeInput = document.getElementById('startTimeInput');
    const currentDurationDisplay = document.getElementById('currentDurationDisplay');
    const currentDurationInput = document.getElementById('currentDurationInput');
    
    if (startTimeDisplay && startTimeInput) {
      startTimeDisplay.style.display = 'block';
      startTimeInput.style.display = 'none';
      startTimeDisplay.textContent = new Date(state.downtimeStartTime).toLocaleTimeString('en-US', 
        { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }
    
    if (currentDurationDisplay && currentDurationInput) {
      currentDurationDisplay.style.display = 'block';
      currentDurationInput.style.display = 'none';
    }
    
    // Update status
    const statusText = document.getElementById('statusText');
    if (statusText) {
      if (state.downtimePaused) {
        statusText.textContent = 'Paused';
        statusText.style.color = 'var(--sap-warning)';
      } else {
        statusText.textContent = 'In Progress';
        statusText.style.color = 'var(--sap-error)';
      }
    }
    
    // Update controls for viewer
    if (!window.canWrite()) {
      const controls = document.getElementById('downtimeControls');
      if (controls) {
        controls.innerHTML = '<div style="color:#666;font-size:12px;">Controlled by host</div>';
      }
    }
    
    // Show current time line
    const currentLine = document.getElementById('currentTimeLine');
    if (currentLine) {
      currentLine.style.display = state.downtimeStarted ? 'block' : 'none';
    }
  }
  
  // Update fullscreen customer info
  if (state.fullscreenMode) {
    window.updateFullscreenCustomerInfo();
  }
  
  // Update tables and timeline
  if (typeof window.renderRunbookTable === 'function') window.renderRunbookTable();
  if (typeof window.updateTimeline === 'function') window.updateTimeline();
  if (typeof window.calculateEndTime === 'function') window.calculateEndTime();
  if (typeof window.updateCompletionPercentage === 'function') window.updateCompletionPercentage();
  
  // Force update duration display for viewers
  if (!window.canWrite() && state.downtimeStarted) {
    const statusText = document.getElementById('statusText');
    if (statusText) {
      statusText.textContent = state.downtimePaused ? 'Paused' : 'In Progress';
      statusText.style.color = state.downtimePaused ? 'var(--sap-warning)' : 'var(--sap-error)';
    }
    
    // Ensure progress panel is visible
    const progressPanel = document.getElementById('progressPanel');
    if (progressPanel) {
      progressPanel.style.display = 'block';
    }
    
    // Force update of current duration
    if (typeof window.updateDuration === 'function') {
      window.updateDuration();
    }
  }
  
  // Update viewer panel
  updateViewerPanel();
}

// Update viewer panel
function updateViewerPanel() {
  const state = window.AppState;
  const isViewer = !window.canWrite();
  
  console.log("Updating viewer panel:", {
    isViewer: isViewer,
    downtimeStarted: state.downtimeStarted,
    hasStartTime: !!state.downtimeStartTime,
    startTime: state.downtimeStartTime
  });
  
  // Update mode display
  const modeEl = document.getElementById("rt-mode");
  if (modeEl) modeEl.textContent = `mode: ${isViewer ? "VIEWER" : "HOST"}`;
  
  // Show/hide viewer panel
  const panel = document.getElementById("rt-viewer-panel");
  if (panel) panel.style.display = isViewer ? "block" : "none";
  
  // If viewer and downtime started, ensure UI shows it
  if (isViewer && state.downtimeStarted) {
    console.log("üìä Viewer: Updating UI for active downtime");
    
    // Show progress panel
    const progressPanel = document.getElementById('progressPanel');
    if (progressPanel) progressPanel.style.display = 'block';
    
    // Update status text
    const statusText = document.getElementById('statusText');
    if (statusText) {
      statusText.textContent = state.downtimePaused ? 'Paused' : 'In Progress';
      statusText.style.color = state.downtimePaused ? 'var(--sap-warning)' : 'var(--sap-error)';
    }
    
    // Show downtime info
    const downtimeInfo = document.getElementById('downtimeInfo');
    if (downtimeInfo) downtimeInfo.style.display = 'block';
    
    // Update start time display
    if (state.downtimeStartTime) {
      const startTimeDisplay = document.getElementById('startTimeDisplay');
      if (startTimeDisplay) {
        const startTime = new Date(state.downtimeStartTime);
        startTimeDisplay.textContent = startTime.toLocaleTimeString('en-US', 
          { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        startTimeDisplay.style.display = 'block';
      }
      
      const startTimeInput = document.getElementById('startTimeInput');
      if (startTimeInput) startTimeInput.style.display = 'none';
    }
    
    // Show current duration display
    const currentDurationDisplay = document.getElementById('currentDurationDisplay');
    if (currentDurationDisplay) currentDurationDisplay.style.display = 'block';
    
    const currentDurationInput = document.getElementById('currentDurationInput');
    if (currentDurationInput) currentDurationInput.style.display = 'none';
  }
  
  // Update sync indicator
  const syncIndicator = document.getElementById("syncIndicator");
  if (syncIndicator) {
    syncIndicator.className = remoteController ? "sync-indicator" : "sync-indicator offline";
  }
  
  if (isViewer) {
    // Apply viewer mode class
    document.body.classList.add('viewer-mode');
    
    // Update viewer status
    const statusEl = document.getElementById("rt-status");
    if (statusEl) {
      if (!state.downtimeStarted) statusEl.textContent = "Not started";
      else if (state.downtimePaused) statusEl.textContent = "Paused";
      else statusEl.textContent = "Running";
    }
    
    // Update start time
    const startEl = document.getElementById("rt-start");
    if (startEl && state.downtimeStartTime) {
      startEl.textContent = new Date(state.downtimeStartTime).toLocaleString();
    }
    
    // Update ETA
    const etaEl = document.getElementById("rt-eta");
    if (etaEl && state.downtimeStartTime) {
      const endTime = new Date(state.downtimeStartTime.getTime() + state.downtimeDuration * 3600000);
      etaEl.textContent = endTime.toLocaleString();
    }
    
    // Update progress bar
    if (state.downtimeStarted && state.downtimeStartTime) {
      const now = Date.now();
      const start = new Date(state.downtimeStartTime).getTime();
      const duration = state.downtimeDuration * 3600000;
      const elapsed = now - start - state.pausedDuration;
      const percent = Math.min(100, Math.max(0, (elapsed / duration) * 100));
      
      const bar = document.getElementById("rt-bar");
      const label = document.getElementById("rt-bar-label");
      if (bar) bar.style.width = `${percent}%`;
      if (label) label.textContent = `${Math.round(percent)}%`;
    }
  } else {
    document.body.classList.remove('viewer-mode');
  }
}

// Push state to Firebase (host only)
async function pushState(reason = "update") {
  if (!window.canWrite() || writing) return;
  
  const currentState = serialize();
  const stateJson = JSON.stringify(currentState);
  
  if (stateJson === lastSentState) return;
  
  writing = true;
  try {
    await window.firestore.updateDoc(sessionRef, {
      state: currentState,
      updatedAt: window.firestore.serverTimestamp(),
      reason
    });
    lastSentState = stateJson;
  } catch (e) {
    try {
      await window.firestore.setDoc(sessionRef, {
        state: currentState,
        controllerUid: uid,
        updatedAt: window.firestore.serverTimestamp(),
        reason
      }, { merge: true });
      lastSentState = stateJson;
    } catch (e2) {
      console.error("Failed to push state:", e2);
    }
  } finally {
    writing = false;
  }
}

// Debounced push
let pushTimer = null;
function schedulePush() {
  clearTimeout(pushTimer);
  pushTimer = setTimeout(() => pushState("debounce"), 250);
}

// Subscribe to session changes
let initialSync = true;
window.firestore.onSnapshot(sessionRef, async (snap) => {
  const data = snap.data() || {};
  remoteController = data.controllerUid || null;
  const isDowntimeActive = data.state?.downtimeStarted || false;
  
  console.log("Session snapshot received:", {
    hasData: !!data,
    hasState: !!data.state,
    remoteController: remoteController,
    isViewer: !window.canWrite(),
    downtimeStarted: isDowntimeActive,
    currentUid: uid
  });
  
  // Apply state
  if (data.state) {
    applyRemoteState(data.state);
  }
  
  // CRITICAL FIX: Only block host mode when downtime is ACTIVE with another controller
  if (!viewerForced && remoteController && remoteController !== uid && isDowntimeActive) {
    console.warn("‚ö†Ô∏è Cannot become host: Downtime is active with another controller");
    alert("‚ö†Ô∏è HOST MODE BLOCKED\n\nAnother user is currently controlling an active downtime session for this customer and transformation cycle.\n\nYou have been switched to VIEWER mode.\n\nWait for the current session to complete or contact the current host.");
    viewerForced = true;
    
    // Update URL to reflect viewer mode
    const url = new URL(window.location.href);
    url.searchParams.set("viewer", "1");
    history.replaceState(null, "", url.toString());
  }
  
  // Try to become controller if none exists, not forced as viewer, AND downtime is NOT active
  // This allows new hosts to take over when no active session is running
  if (!remoteController && !viewerForced && !isDowntimeActive && initialSync) {
    try {
      await window.firestore.setDoc(sessionRef, {
        controllerUid: uid,
        controllerSetAt: window.firestore.serverTimestamp()
      }, { merge: true });
      console.log("‚úì Became controller:", uid);
    } catch (e) {
      console.error("Failed to set controller:", e);
    }
  }
  
  // Update UI based on role
  updateViewerPanel();
  
  if (initialSync) {
    initialSync = false;
    lastSentState = JSON.stringify(serialize());
    console.log("Initial sync complete, mode:", window.canWrite() ? "HOST" : "VIEWER");
    
    // CRITICAL FIX: For viewers, force UI update and start duration counter
    if (!window.canWrite() && data.state) {
      console.log("üîÑ Forcing viewer UI update on initial load");
      setTimeout(() => {
        updateViewerPanel();
        if (typeof window.updateDuration === 'function') window.updateDuration();
        if (typeof window.updateTimeline === 'function') window.updateTimeline();
        
        // Start continuous updates for viewers when downtime is active
        if (window.AppState.downtimeStarted) {
          console.log("üîÑ Starting viewer duration counter");
          // Duration updates handled by interval below
        }
      }, 500);
    }
  }
});

// Hook into mutation functions (including fullscreen toggle)
const mutationFunctions = [
  "startDowntime", "pauseDowntime", "resumeDowntime", "stopDowntime",
  "addRunbookRow", "removeRunbook", "clearRunbook",
  "updateSequence", "updateStrategy", "updatePhase", "updateRunblock",
  "updateResponsibility", "updateCritical", "updateScheduleTime",
  "updateDurationTime", "toggleCompleted", "calculateEndTime", "updateTimeline",
  "updateStatus", "duplicateRunbook", "filterRunbooks", "clearFilters",
  "toggleFullscreenMode"
];

mutationFunctions.forEach(fnName => {
  const original = window[fnName];
  if (typeof original === "function") {
    window[fnName] = function(...args) {
      const result = original.apply(this, args);
      if (window.canWrite()) schedulePush();
      return result;
    };
  }
});

// Watch input changes
["customerName", "transformCycle", "downtimeDuration"].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener("change", () => {
      if (window.canWrite()) schedulePush();
    });
  }
});

// Update timeline position for viewers and hosts
setInterval(() => {
  if (window.AppState.downtimeStarted && window.AppState.downtimeStartTime) {
    // Calculate current position
    const now = new Date();
    const elapsed = (now - new Date(window.AppState.downtimeStartTime) - window.AppState.pausedDuration) / 3600000;
    const pixelsPerHour = 60;
    const linePosition = Math.min(elapsed * pixelsPerHour, window.AppState.downtimeDuration * pixelsPerHour);
    
    // Update timeline
    const currentLine = document.getElementById('currentTimeLine');
    if (currentLine) {
      currentLine.style.left = `${linePosition}px`;
      currentLine.style.display = 'block';
      
      // Update label
      const elapsedMs = now - new Date(window.AppState.downtimeStartTime) - window.AppState.pausedDuration;
      const totalSeconds = Math.floor(elapsedMs / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      const label = document.getElementById('currentTimeLabel');
      if (label) {
        label.textContent = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
      }
    }
    
    // Update duration display
    if (typeof window.updateDuration === 'function') window.updateDuration();
    
    // Update main duration text in header
    const durationText = document.getElementById('durationText');
    if (durationText) {
      const elapsedMs = now - new Date(window.AppState.downtimeStartTime) - window.AppState.pausedDuration;
      const totalSeconds = Math.floor(elapsedMs / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      durationText.textContent = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }
    
    // Update viewer panel
    updateViewerPanel();
    
    // Force update of progress indicators for viewers
    if (!window.canWrite()) {
      updateProgressIndicators();
      
      // Ensure viewer sees the active session UI
      const progressPanel = document.getElementById('progressPanel');
      if (progressPanel) progressPanel.style.display = 'block';
    }
  }
}, 1000);

// Reset function
document.getElementById("rt-reset").onclick = async function() {
  if (!window.canWrite()) {
    alert("Only the host can reset the session.");
    return;
  }
  
  if (!confirm("Reset the session for ALL viewers? This will clear all data and release host control.")) return;
  
  // Clear state
  window.AppState = {
    runbooks: [],
    downtimeStarted: false,
    downtimeStartTime: null,
    downtimeDuration: 24,
    downtimePaused: false,
    pausedDuration: 0,
    pauseStartTime: null,
    currentDraggedBlock: null,
    dragOffset: 0,
    completionTimes: {},
    isFirstUser: false,
    syncedTimelinePosition: 0,
    renderLock: false,
    messagesOn: false,
    fullscreenMode: false
  };
  
  // Reset UI
  document.getElementById('customerName').value = '';
  document.getElementById('transformCycle').value = 'Test Migration';
  document.getElementById('downtimeDuration').value = '24';
  
  // CRITICAL FIX: Clear controller from Firebase to allow new hosts
  try {
    await window.firestore.setDoc(sessionRef, {
      controllerUid: null,
      state: serialize(),
      updatedAt: window.firestore.serverTimestamp(),
      reason: "reset"
    }, { merge: true });
    console.log("‚úì Session reset, controller released");
  } catch (e) {
    console.error("Failed to reset session:", e);
    // Still push the reset state even if Firebase update fails
    await pushState("reset");
  }
  
  // Reload to ensure clean state
  window.location.reload();
};

console.log("Firebase sync initialized - Mode:", window.canWrite() ? "HOST" : "VIEWER");
</script>

</body>
</html>